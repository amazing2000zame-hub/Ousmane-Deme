---
phase: 32-web-browsing-video-playback
plan: 04
type: execute
wave: 4
depends_on: [32-03]
files_modified:
  - jarvis-backend/src/mcp/tools/web.ts
  - jarvis-backend/src/safety/tiers.ts
  - jarvis-backend/src/ai/tools.ts
  - jarvis-ui/src/components/center/InlineVideoCard.tsx
  - jarvis-ui/src/stores/chat.ts
  - jarvis-ui/src/hooks/useChatSocket.ts
  - jarvis-ui/src/components/center/ChatMessage.tsx
autonomous: true

must_haves:
  truths:
    - "User can say 'search for cat videos on YouTube' and get video results"
    - "User can say 'play never gonna give you up' and see YouTube embed playing"
    - "YouTube uses privacy-enhanced nocookie domain"
    - "Video ID validation prevents injection attacks"
  artifacts:
    - path: "jarvis-backend/src/mcp/tools/web.ts"
      provides: "search_youtube and play_youtube tools"
      contains: "search_youtube"
    - path: "jarvis-ui/src/components/center/InlineVideoCard.tsx"
      provides: "YouTube embed player"
      contains: "InlineVideoCard"
---

<objective>
Add YouTube search and playback capabilities with search_youtube and play_youtube tools, plus the InlineVideoCard component. This is Wave 4 of Phase 32.

Purpose: Enable JARVIS to search and play YouTube videos inline in the chat.

Output: Users can search YouTube and watch videos embedded in the chat interface.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/32-web-browsing-video-playback/32-RESEARCH.md

Source files to modify:
@jarvis-backend/src/mcp/tools/web.ts
@jarvis-backend/src/safety/tiers.ts
@jarvis-backend/src/ai/tools.ts
@jarvis-ui/src/stores/chat.ts
@jarvis-ui/src/hooks/useChatSocket.ts
@jarvis-ui/src/components/center/ChatMessage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add search_youtube tool</name>
  <files>jarvis-backend/src/mcp/tools/web.ts</files>
  <action>
  Add search_youtube tool using SearXNG with YouTube engine.

  ```typescript
  // search_youtube - Search for YouTube videos
  server.tool(
    'search_youtube',
    'Search for videos on YouTube. Returns video titles, URLs, and descriptions. Use this when users want to find videos, YouTube content, or something to watch.',
    {
      query: z.string().describe('What to search for on YouTube'),
      limit: z.number().min(1).max(10).optional().describe('Maximum number of results (default: 5)'),
    },
    async ({ query, limit = 5 }) => {
      try {
        const searchUrl = new URL('/search', config.searxngUrl);
        searchUrl.searchParams.set('q', query);
        searchUrl.searchParams.set('format', 'json');
        searchUrl.searchParams.set('categories', 'videos');
        searchUrl.searchParams.set('engines', 'youtube');

        console.log(`[WEB] YouTube search: "${query}"`);

        const response = await fetch(searchUrl.toString(), {
          headers: { 'Accept': 'application/json' },
          signal: AbortSignal.timeout(10000),
        });

        if (!response.ok) {
          throw new Error(`SearXNG returned ${response.status}`);
        }

        const data = await response.json() as SearXNGResponse;

        interface YouTubeResult {
          title: string;
          url: string;
          videoId: string;
          description: string;
          thumbnail?: string;
        }

        const results: YouTubeResult[] = data.results
          .slice(0, limit)
          .filter(r => r.url?.includes('youtube.com/watch') || r.url?.includes('youtu.be/'))
          .map(r => {
            // Extract video ID from URL
            let videoId = '';
            const watchMatch = r.url.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
            const shortMatch = r.url.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
            if (watchMatch) videoId = watchMatch[1];
            else if (shortMatch) videoId = shortMatch[1];

            return {
              title: r.title,
              url: r.url,
              videoId,
              description: r.content || '',
              thumbnail: videoId ? `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg` : undefined,
            };
          })
          .filter(r => r.videoId); // Only include results with valid video IDs

        console.log(`[WEB] Found ${results.length} YouTube videos`);

        if (results.length === 0) {
          return {
            content: [{ type: 'text', text: `No YouTube videos found for "${query}"` }],
          };
        }

        // Emit to UI
        if (chatNs) {
          chatNs.emit('chat:show_search_results', {
            query: `YouTube: ${query}`,
            results: results.map(r => ({
              title: r.title,
              url: r.url,
              snippet: r.description,
              engine: 'youtube',
            })),
            timestamp: new Date().toISOString(),
          });
        }

        const formatted = results.map((r, i) =>
          `${i + 1}. **${r.title}**\n   ${r.url}\n   Video ID: ${r.videoId}`
        ).join('\n\n');

        return {
          content: [{
            type: 'text',
            text: `Found ${results.length} YouTube videos for "${query}":\n\n${formatted}\n\nSay "play [title]" or "play video [number]" to watch.`
          }],
        };
      } catch (err) {
        const message = err instanceof Error ? err.message : String(err);
        console.error(`[WEB] YouTube search error: ${message}`);
        return {
          content: [{ type: 'text', text: `YouTube search failed: ${message}` }],
          isError: true,
        };
      }
    },
  );
  ```
  </action>
  <verify>
  ```bash
  grep -n "search_youtube" /root/jarvis-backend/src/mcp/tools/web.ts
  ```
  </verify>
  <done>
  - search_youtube tool added
  - Uses SearXNG with YouTube engine
  - Extracts video IDs from URLs
  </done>
</task>

<task type="auto">
  <name>Task 2: Add play_youtube tool</name>
  <files>jarvis-backend/src/mcp/tools/web.ts</files>
  <action>
  Add play_youtube tool that embeds a YouTube video player.

  Add video ID validation helper:
  ```typescript
  function validateYouTubeVideoId(input: string): string | null {
    // Direct video ID (11 chars, alphanumeric + dash + underscore)
    if (/^[a-zA-Z0-9_-]{11}$/.test(input)) {
      return input;
    }

    // YouTube URL patterns
    const watchMatch = input.match(/[?&]v=([a-zA-Z0-9_-]{11})/);
    if (watchMatch) return watchMatch[1];

    const shortMatch = input.match(/youtu\.be\/([a-zA-Z0-9_-]{11})/);
    if (shortMatch) return shortMatch[1];

    const embedMatch = input.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/);
    if (embedMatch) return embedMatch[1];

    return null;
  }
  ```

  Add the tool:
  ```typescript
  // play_youtube - Embed YouTube video player
  server.tool(
    'play_youtube',
    'Play a YouTube video in the chat interface. Use this when users want to play, watch, or see a YouTube video.',
    {
      videoId: z.string().optional().describe('YouTube video ID (11 characters) or full URL'),
      url: z.string().optional().describe('YouTube video URL'),
      title: z.string().optional().describe('Video title for display'),
    },
    async ({ videoId, url, title }) => {
      try {
        const input = videoId || url;
        if (!input) {
          return {
            content: [{ type: 'text', text: 'Please provide a video ID or URL' }],
            isError: true,
          };
        }

        const validatedId = validateYouTubeVideoId(input);
        if (!validatedId) {
          return {
            content: [{ type: 'text', text: 'Invalid YouTube video ID or URL' }],
            isError: true,
          };
        }

        console.log(`[WEB] Playing YouTube video: ${validatedId}`);

        // Emit to UI
        if (chatNs) {
          chatNs.emit('chat:show_video', {
            type: 'youtube',
            videoId: validatedId,
            title: title || 'YouTube Video',
            timestamp: new Date().toISOString(),
          });
        }

        return {
          content: [{
            type: 'text',
            text: `Playing YouTube video${title ? `: ${title}` : ''}.`
          }],
        };
      } catch (err) {
        const message = err instanceof Error ? err.message : String(err);
        console.error(`[WEB] Play YouTube error: ${message}`);
        return {
          content: [{ type: 'text', text: `Failed to play video: ${message}` }],
          isError: true,
        };
      }
    },
  );
  ```
  </action>
  <verify>
  ```bash
  grep -n "play_youtube\|validateYouTubeVideoId" /root/jarvis-backend/src/mcp/tools/web.ts
  ```
  </verify>
  <done>
  - play_youtube tool added
  - Video ID validation implemented
  - Emits chat:show_video event
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tools to safety tiers and Claude</name>
  <files>jarvis-backend/src/safety/tiers.ts, jarvis-backend/src/ai/tools.ts</files>
  <action>
  In tiers.ts, add:
  ```typescript
  search_youtube: ActionTier.GREEN,
  play_youtube: ActionTier.GREEN,
  ```

  In tools.ts, add to getClaudeTools():
  ```typescript
  {
    name: 'search_youtube',
    description: "Search for videos on YouTube. Use this when users ask to find YouTube videos, search for videos, or look for something to watch.",
    input_schema: {
      type: 'object',
      properties: {
        query: {
          type: 'string',
          description: 'What to search for on YouTube',
        },
        limit: {
          type: 'number',
          description: 'Maximum results (1-10, default 5)',
        },
      },
      required: ['query'],
    },
  },
  {
    name: 'play_youtube',
    description: "Play a YouTube video in the chat. Use this when users want to play, watch, or see a specific YouTube video. Accepts video ID or full URL.",
    input_schema: {
      type: 'object',
      properties: {
        videoId: {
          type: 'string',
          description: 'YouTube video ID (11 chars) or full YouTube URL',
        },
        title: {
          type: 'string',
          description: 'Video title for display',
        },
      },
      required: ['videoId'],
    },
  },
  ```
  </action>
  <verify>
  ```bash
  grep -n "search_youtube\|play_youtube" /root/jarvis-backend/src/safety/tiers.ts /root/jarvis-backend/src/ai/tools.ts
  ```
  </verify>
  <done>
  - Both tools assigned GREEN tier
  - Claude tool definitions added
  </done>
</task>

<task type="auto">
  <name>Task 4: Add inlineVideo to chat store</name>
  <files>jarvis-ui/src/stores/chat.ts</files>
  <action>
  Add inline video state.

  Add interface:
  ```typescript
  interface InlineVideo {
    type: 'youtube' | 'direct';
    videoId?: string;    // For YouTube
    url?: string;        // For direct video
    title: string;
    timestamp: string;
  }
  ```

  Add to ChatMessage:
  ```typescript
  inlineVideo?: InlineVideo;
  ```

  Add actions:
  ```typescript
  setInlineVideo: (video: InlineVideo) => void;
  clearInlineVideo: () => void;
  ```

  Implement:
  ```typescript
  setInlineVideo: (video) => {
    set((state) => {
      const messages = [...state.messages];
      for (let i = messages.length - 1; i >= 0; i--) {
        if (messages[i].role === 'assistant') {
          messages[i] = { ...messages[i], inlineVideo: video };
          break;
        }
      }
      return { messages };
    });
  },
  clearInlineVideo: () => {
    set((state) => {
      const messages = [...state.messages];
      for (let i = messages.length - 1; i >= 0; i--) {
        if (messages[i].role === 'assistant' && messages[i].inlineVideo) {
          const { inlineVideo, ...rest } = messages[i];
          messages[i] = rest;
          break;
        }
      }
      return { messages };
    });
  },
  ```
  </action>
  <verify>
  ```bash
  grep -n "inlineVideo\|InlineVideo" /root/jarvis-ui/src/stores/chat.ts
  ```
  </verify>
  <done>
  - InlineVideo interface defined
  - setInlineVideo and clearInlineVideo actions added
  </done>
</task>

<task type="auto">
  <name>Task 5: Create InlineVideoCard component</name>
  <files>jarvis-ui/src/components/center/InlineVideoCard.tsx</files>
  <action>
  Create the video player component.

  ```typescript
  import React, { useCallback } from 'react';
  import { useChatStore } from '../../stores/chat';
  import './InlineVideoCard.css';

  interface InlineVideoCardProps {
    type: 'youtube' | 'direct';
    videoId?: string;
    url?: string;
    title: string;
    timestamp: string;
  }

  export const InlineVideoCard: React.FC<InlineVideoCardProps> = React.memo(
    ({ type, videoId, url, title, timestamp }) => {
      const clearInlineVideo = useChatStore((s) => s.clearInlineVideo);

      const handleClose = useCallback(() => {
        clearInlineVideo();
      }, [clearInlineVideo]);

      const handleOpenExternal = useCallback(() => {
        const externalUrl = type === 'youtube'
          ? `https://www.youtube.com/watch?v=${videoId}`
          : url;
        if (externalUrl) {
          window.open(externalUrl, '_blank', 'noopener,noreferrer');
        }
      }, [type, videoId, url]);

      // YouTube embed URL with privacy-enhanced mode
      const embedUrl = type === 'youtube' && videoId
        ? `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`
        : null;

      return (
        <div className="inline-video-card">
          <div className="inline-video-header">
            <span className="video-icon">{type === 'youtube' ? '‚ñ∂Ô∏è' : 'üé¨'}</span>
            <span className="video-title">{title}</span>
            <div className="video-actions">
              <button
                className="video-action-btn"
                onClick={handleOpenExternal}
                title="Open on YouTube"
              >
                ‚Üó
              </button>
              <button
                className="video-action-btn video-close-btn"
                onClick={handleClose}
                title="Close"
              >
                ‚úï
              </button>
            </div>
          </div>
          <div className="inline-video-content">
            {type === 'youtube' && embedUrl && (
              <iframe
                src={embedUrl}
                title={title}
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowFullScreen
              />
            )}
            {type === 'direct' && url && (
              <video
                src={url}
                controls
                autoPlay
                title={title}
              >
                Your browser does not support video playback.
              </video>
            )}
          </div>
          <div className="inline-video-footer">
            {type === 'youtube' && videoId && (
              <span className="video-id">ID: {videoId}</span>
            )}
            {type === 'direct' && url && (
              <span className="video-url">{url}</span>
            )}
            <span className="video-timestamp">
              {new Date(timestamp).toLocaleTimeString()}
            </span>
          </div>
        </div>
      );
    }
  );

  InlineVideoCard.displayName = 'InlineVideoCard';
  ```

  Create CSS file `InlineVideoCard.css`:
  ```css
  .inline-video-card {
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid var(--hud-color, #0af);
    border-radius: 8px;
    margin: 8px 0;
    overflow: hidden;
    max-width: 640px;
  }

  .inline-video-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: rgba(255, 0, 0, 0.1);
    border-bottom: 1px solid rgba(255, 0, 0, 0.3);
  }

  .video-icon {
    font-size: 16px;
  }

  .video-title {
    flex: 1;
    color: #fff;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .video-actions {
    display: flex;
    gap: 4px;
  }

  .video-action-btn {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #fff;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.2s;
  }

  .video-action-btn:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .video-close-btn:hover {
    background: rgba(255, 0, 0, 0.2);
    border-color: #f44;
    color: #f44;
  }

  .inline-video-content {
    position: relative;
    width: 100%;
    padding-bottom: 56.25%; /* 16:9 aspect ratio */
    background: #000;
  }

  .inline-video-content iframe,
  .inline-video-content video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }

  .inline-video-footer {
    display: flex;
    justify-content: space-between;
    padding: 6px 12px;
    font-size: 10px;
    color: rgba(255, 255, 255, 0.5);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .video-id,
  .video-url {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }
  ```
  </action>
  <verify>
  ```bash
  ls -la /root/jarvis-ui/src/components/center/InlineVideoCard.* && cd /root/jarvis-ui && npx tsc --noEmit 2>&1 | head -10
  ```
  </verify>
  <done>
  - InlineVideoCard.tsx created
  - YouTube nocookie embed with autoplay
  - Direct video with HTML5 player
  - InlineVideoCard.css created
  </done>
</task>

<task type="auto">
  <name>Task 6: Add socket handler and render component</name>
  <files>jarvis-ui/src/hooks/useChatSocket.ts, jarvis-ui/src/components/center/ChatMessage.tsx</files>
  <action>
  In useChatSocket.ts, add handlers:
  ```typescript
  function onShowVideo(data: { type: 'youtube' | 'direct'; videoId?: string; url?: string; title: string; timestamp: string }) {
    useChatStore.getState().setInlineVideo(data);
  }

  function onCloseVideo() {
    useChatStore.getState().clearInlineVideo();
  }
  ```

  Register listeners:
  ```typescript
  socket.on('chat:show_video', onShowVideo);
  socket.on('chat:close_video', onCloseVideo);
  ```

  Add cleanup.

  In ChatMessage.tsx:
  ```typescript
  import { InlineVideoCard } from './InlineVideoCard';

  // In render:
  {message.inlineVideo && (
    <InlineVideoCard
      type={message.inlineVideo.type}
      videoId={message.inlineVideo.videoId}
      url={message.inlineVideo.url}
      title={message.inlineVideo.title}
      timestamp={message.inlineVideo.timestamp}
    />
  )}
  ```
  </action>
  <verify>
  ```bash
  grep -n "show_video\|InlineVideoCard" /root/jarvis-ui/src/hooks/useChatSocket.ts /root/jarvis-ui/src/components/center/ChatMessage.tsx
  ```
  </verify>
  <done>
  - Socket handlers added
  - InlineVideoCard rendered in ChatMessage
  </done>
</task>

<task type="auto">
  <name>Task 7: Add router keywords for YouTube</name>
  <files>jarvis-backend/src/ai/router.ts</files>
  <action>
  Add YouTube-related keywords.

  Add to ACTION_KEYWORDS:
  ```typescript
  'youtube',
  'play',
  'watch',
  'video',
  ```

  Add entity pattern:
  ```typescript
  /\b(youtube|video|videos|watch|play)\b/i,
  ```
  </action>
  <verify>
  ```bash
  grep -n "'youtube'\|'video'\|'watch'" /root/jarvis-backend/src/ai/router.ts
  ```
  </verify>
  <done>
  - YouTube keywords added to router
  </done>
</task>

</tasks>

<verification>
1. **Build and deploy:**
   ```bash
   cd /root && docker compose up -d --build
   ```

2. **Test YouTube search:**
   Ask "search for cat videos on YouTube"
   - Should see video results with titles

3. **Test YouTube playback:**
   Ask "play dQw4w9WgXcQ" (Rick Roll video ID)
   - Should see embedded YouTube player
   - Autoplay should work
   - Close button should work

4. **Test URL parsing:**
   Ask "play https://www.youtube.com/watch?v=dQw4w9WgXcQ"
   - Should extract video ID and play
</verification>

<success_criteria>
1. search_youtube returns video results
2. play_youtube embeds working player
3. YouTube nocookie domain used
4. Video ID validation works
5. Autoplay and controls work
6. TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/32-web-browsing-video-playback/32-04-SUMMARY.md`
</output>
