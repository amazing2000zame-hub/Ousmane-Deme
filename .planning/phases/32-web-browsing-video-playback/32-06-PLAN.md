---
phase: 32-web-browsing-video-playback
plan: 06
type: execute
wave: 6
depends_on: [32-05]
files_modified:
  - jarvis-backend/src/ai/system-prompt.ts
  - jarvis-ui/src/components/center/ChatPanel.tsx
autonomous: true

must_haves:
  truths:
    - "System prompt includes guidance on new web and video capabilities"
    - "Escape key closes any open inline content (video, webpage, camera)"
    - "Loading states show while content loads"
  artifacts:
    - path: "jarvis-backend/src/ai/system-prompt.ts"
      provides: "Updated JARVIS capabilities"
      contains: "web search"
---

<objective>
Polish the implementation with system prompt updates, keyboard shortcuts, and UX improvements. This is Wave 6 (final) of Phase 32.

Purpose: Ensure JARVIS knows about and properly uses its new capabilities, and provide good UX for dismissing content.

Output: Complete, polished web browsing and video playback experience.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/32-web-browsing-video-playback/32-RESEARCH.md

Source files to modify:
@jarvis-backend/src/ai/system-prompt.ts
@jarvis-ui/src/components/center/ChatPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update system prompt with web capabilities</name>
  <files>jarvis-backend/src/ai/system-prompt.ts</files>
  <action>
  Add web browsing and video capabilities to JARVIS's system prompt.

  Find the capabilities section and add:
  ```
  ## Web Browsing & Video

  You can help users search the web and view content:

  - **Web Search**: Use \`web_search\` to find information online. Results appear inline in chat.
  - **View Webpages**: Use \`open_url\` to display websites in an embedded viewer, or \`fetch_webpage\` to get and summarize content.
  - **YouTube**: Use \`search_youtube\` to find videos, and \`play_youtube\` to play them inline.
  - **Direct Video**: Use \`play_video\` for mp4/webm URLs.
  - **Open in Browser**: Use \`open_in_browser\` to launch sites in a real browser on a cluster node.

  When users ask to search, browse, or watch videos, use these tools to provide interactive results.
  ```
  </action>
  <verify>
  ```bash
  grep -n "web_search\|Web Browsing" /root/jarvis-backend/src/ai/system-prompt.ts
  ```
  </verify>
  <done>
  - System prompt includes web browsing guidance
  - Tool usage examples provided
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Escape key to close inline content</name>
  <files>jarvis-ui/src/components/center/ChatPanel.tsx</files>
  <action>
  Add keyboard event handler to close inline content with Escape key.

  Add useEffect hook for keyboard handling:
  ```typescript
  useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (event.key === 'Escape') {
        // Close any open inline content
        const store = useChatStore.getState();
        store.clearInlineCamera?.();
        store.clearInlineWebpage?.();
        store.clearInlineVideo?.();
      }
    };

    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, []);
  ```

  Make sure to import useChatStore if not already imported.
  </action>
  <verify>
  ```bash
  grep -n "Escape\|handleKeyDown" /root/jarvis-ui/src/components/center/ChatPanel.tsx
  ```
  </verify>
  <done>
  - Escape key closes inline camera, webpage, and video
  - Event listener properly cleaned up
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify all components have loading states</name>
  <files>Multiple component files</files>
  <action>
  Review and ensure all inline components have proper loading states:

  1. InlineWebCard - already has loading spinner
  2. InlineVideoCard - YouTube iframe loads automatically, direct video shows controls
  3. SearchResultsCard - instant render (no async loading)
  4. InlineCameraCard - already has CONNECTING state

  No changes needed if loading states are present. Verify by checking the components.
  </action>
  <verify>
  ```bash
  grep -n "loading\|Loading\|CONNECTING" /root/jarvis-ui/src/components/center/InlineWebCard.tsx /root/jarvis-ui/src/components/center/InlineVideoCard.tsx
  ```
  </verify>
  <done>
  - All components have appropriate loading indicators
  </done>
</task>

</tasks>

<verification>
1. **Build and deploy:**
   ```bash
   cd /root && docker compose up -d --build
   ```

2. **Full end-to-end tests:**

   a. **Web search:**
      Ask "search for weather in New York"
      - Results should appear inline
      - Click a result → opens in new tab

   b. **Webpage viewing:**
      Ask "show me example.com"
      - Iframe should load
      - Press Escape → should close
      - Click ↗ → opens in new tab

   c. **YouTube search:**
      Ask "search for cat videos on YouTube"
      - Video results should appear

   d. **YouTube playback:**
      Ask "play dQw4w9WgXcQ"
      - YouTube embed should play
      - Press Escape → should close

   e. **Direct video:**
      Ask "play https://www.w3schools.com/html/mov_bbb.mp4"
      - HTML5 video should play

   f. **Open in browser:**
      Ask "open google.com in the browser"
      - Should be YELLOW tier (logged)
      - Should attempt to open on Home node

3. **Keyboard shortcuts:**
   - Open any inline content, press Escape
   - Content should close
</verification>

<success_criteria>
1. System prompt updated with web capabilities
2. Escape key closes inline content
3. All loading states work
4. Full test suite passes
5. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-web-browsing-video-playback/32-06-SUMMARY.md` and `.planning/phases/32-web-browsing-video-playback/32-VERIFICATION.md`
</output>
