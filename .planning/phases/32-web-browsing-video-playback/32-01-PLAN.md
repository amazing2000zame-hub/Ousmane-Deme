---
phase: 32-web-browsing-video-playback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker-compose.yml
  - jarvis-backend/src/mcp/tools/web.ts
  - jarvis-backend/src/mcp/server.ts
  - jarvis-backend/src/safety/tiers.ts
  - jarvis-backend/src/ai/tools.ts
  - jarvis-backend/src/ai/router.ts
  - jarvis-backend/src/config.ts
autonomous: true

must_haves:
  truths:
    - "SearXNG container runs and responds to search queries at http://jarvis-searxng:8080/search"
    - "User can ask 'search for weather in New York' and get search results returned by Claude"
    - "web_search tool is GREEN tier (auto-execute, no confirmation)"
    - "Router routes web search queries to Claude instead of Qwen"
  artifacts:
    - path: "docker-compose.yml"
      provides: "SearXNG service definition"
      contains: "jarvis-searxng"
    - path: "jarvis-backend/src/mcp/tools/web.ts"
      provides: "web_search MCP tool"
      contains: "web_search"
    - path: "jarvis-backend/src/mcp/server.ts"
      provides: "Web tools registration"
      contains: "registerWebTools"
    - path: "jarvis-backend/src/safety/tiers.ts"
      provides: "web_search tier assignment"
      contains: "web_search: ActionTier.GREEN"
    - path: "jarvis-backend/src/ai/tools.ts"
      provides: "Claude tool definition for web_search"
      contains: "web_search"
    - path: "jarvis-backend/src/config.ts"
      provides: "SEARXNG_URL config"
      contains: "searxngUrl"
  key_links:
    - from: "jarvis-backend/src/mcp/tools/web.ts"
      to: "jarvis-backend/src/config.ts"
      via: "import config for searxngUrl"
      pattern: "config.searxngUrl"
---

<objective>
Add SearXNG container and implement the web_search MCP tool as the foundation for web browsing capabilities. This is Wave 1 of Phase 32.

Purpose: Enable JARVIS to search the web for information using a privacy-focused, self-hosted search engine. SearXNG aggregates results from multiple search engines without tracking.

Output: Working web search capability accessible via chat. User says "search for X" and gets relevant results.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/32-web-browsing-video-playback/32-RESEARCH.md

Source files to modify:
@docker-compose.yml
@jarvis-backend/src/config.ts
@jarvis-backend/src/mcp/server.ts
@jarvis-backend/src/safety/tiers.ts
@jarvis-backend/src/ai/tools.ts
@jarvis-backend/src/ai/router.ts

Reference files (read-only):
@jarvis-backend/src/mcp/tools/smarthome.ts (pattern for tool registration)
@jarvis-backend/src/mcp/tools/files.ts (pattern for tool registration)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SearXNG Docker service</name>
  <files>docker-compose.yml</files>
  <action>
  Add the SearXNG service to docker-compose.yml. Add it after the jarvis-tts service.

  ```yaml
  jarvis-searxng:
    image: searxng/searxng:latest
    container_name: jarvis-searxng
    restart: unless-stopped
    environment:
      - SEARXNG_BASE_URL=http://localhost:8888
    volumes:
      - searxng-data:/etc/searxng
    networks:
      - jarvis-net
    deploy:
      resources:
        limits:
          memory: 512M
  ```

  Also add the volume declaration at the bottom in the volumes section:
  ```yaml
  volumes:
    searxng-data:
  ```

  IMPORTANT: SearXNG runs on port 8080 internally. Do NOT expose the port externally - it should only be accessible from other containers on jarvis-net.
  </action>
  <verify>
  ```bash
  cd /root && docker compose config --quiet && echo "Config valid"
  ```
  </verify>
  <done>
  - docker-compose.yml contains jarvis-searxng service
  - searxng-data volume declared
  - Service on jarvis-net network
  - Memory limit 512M set
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SearXNG URL to config</name>
  <files>jarvis-backend/src/config.ts</files>
  <action>
  Add the SearXNG URL configuration to config.ts.

  Add to the config object (after the existing properties):
  ```typescript
  searxngUrl: process.env.SEARXNG_URL || 'http://jarvis-searxng:8080',
  ```

  This uses the Docker service name for container-to-container communication.
  </action>
  <verify>
  ```bash
  grep -n "searxngUrl" /root/jarvis-backend/src/config.ts
  ```
  </verify>
  <done>
  - config.ts exports searxngUrl with default http://jarvis-searxng:8080
  </done>
</task>

<task type="auto">
  <name>Task 3: Create web.ts with web_search tool</name>
  <files>jarvis-backend/src/mcp/tools/web.ts</files>
  <action>
  Create the new web tools file with the web_search tool.

  ```typescript
  import { McpServer } from '@anthropic-ai/sdk';
  import { z } from 'zod';
  import config from '../../config.js';

  interface SearchResult {
    title: string;
    url: string;
    snippet: string;
    engine?: string;
  }

  interface SearXNGResponse {
    results: Array<{
      title: string;
      url: string;
      content?: string;
      engine?: string;
    }>;
    query: string;
    number_of_results: number;
  }

  export function registerWebTools(server: McpServer): void {
    // web_search - Search the web via SearXNG
    server.tool(
      'web_search',
      'Search the web for information. Returns titles, URLs, and snippets from multiple search engines. Use this when users ask to search for something, look something up, or need current information.',
      {
        query: z.string().describe('The search query'),
        limit: z.number().min(1).max(20).optional().describe('Maximum number of results to return (default: 5)'),
        engines: z.string().optional().describe('Comma-separated list of search engines (e.g., "google,bing,duckduckgo"). Leave empty for all.'),
      },
      async ({ query, limit = 5, engines }) => {
        try {
          const searchUrl = new URL('/search', config.searxngUrl);
          searchUrl.searchParams.set('q', query);
          searchUrl.searchParams.set('format', 'json');
          if (engines) {
            searchUrl.searchParams.set('engines', engines);
          }

          console.log(`[WEB] Searching: "${query}" via SearXNG`);

          const response = await fetch(searchUrl.toString(), {
            headers: {
              'Accept': 'application/json',
            },
            signal: AbortSignal.timeout(10000),
          });

          if (!response.ok) {
            throw new Error(`SearXNG returned ${response.status}: ${response.statusText}`);
          }

          const data = await response.json() as SearXNGResponse;

          const results: SearchResult[] = data.results
            .slice(0, limit)
            .map(r => ({
              title: r.title,
              url: r.url,
              snippet: r.content || '',
              engine: r.engine,
            }));

          console.log(`[WEB] Found ${data.number_of_results} results, returning ${results.length}`);

          if (results.length === 0) {
            return {
              content: [{ type: 'text', text: `No results found for "${query}"` }],
            };
          }

          // Format results for Claude
          const formatted = results.map((r, i) =>
            `${i + 1}. **${r.title}**\n   ${r.url}\n   ${r.snippet}`
          ).join('\n\n');

          return {
            content: [{
              type: 'text',
              text: `Found ${data.number_of_results} results for "${query}":\n\n${formatted}`
            }],
          };
        } catch (err) {
          const message = err instanceof Error ? err.message : String(err);
          console.error(`[WEB] Search error: ${message}`);
          return {
            content: [{ type: 'text', text: `Search failed: ${message}` }],
            isError: true,
          };
        }
      },
    );
  }
  ```
  </action>
  <verify>
  ```bash
  cd /root/jarvis-backend && npx tsc --noEmit 2>&1 | head -20
  ```
  </verify>
  <done>
  - web.ts created with registerWebTools function
  - web_search tool implemented with query, limit, engines parameters
  - Error handling and timeout included
  - Results formatted for Claude consumption
  </done>
</task>

<task type="auto">
  <name>Task 4: Register web tools in server.ts</name>
  <files>jarvis-backend/src/mcp/server.ts</files>
  <action>
  Import and register the web tools in the MCP server.

  Add import at the top with other tool imports:
  ```typescript
  import { registerWebTools } from './tools/web.js';
  ```

  Add registration call in the createMcpServer function, after the other registerXxxTools calls:
  ```typescript
  registerWebTools(server);
  ```
  </action>
  <verify>
  ```bash
  grep -n "registerWebTools\|web.js" /root/jarvis-backend/src/mcp/server.ts
  ```
  </verify>
  <done>
  - registerWebTools imported from ./tools/web.js
  - registerWebTools(server) called in createMcpServer
  </done>
</task>

<task type="auto">
  <name>Task 5: Add web_search to safety tiers</name>
  <files>jarvis-backend/src/safety/tiers.ts</files>
  <action>
  Add the web_search tool to the TOOL_TIERS map with GREEN tier.

  Add to the TOOL_TIERS Record:
  ```typescript
  // Web tools
  web_search: ActionTier.GREEN,
  ```

  Place it with the other GREEN tier tools, logically grouped.
  </action>
  <verify>
  ```bash
  grep -n "web_search" /root/jarvis-backend/src/safety/tiers.ts
  ```
  </verify>
  <done>
  - web_search assigned ActionTier.GREEN in TOOL_TIERS
  </done>
</task>

<task type="auto">
  <name>Task 6: Add web_search to Claude tools</name>
  <files>jarvis-backend/src/ai/tools.ts</files>
  <action>
  Add the web_search tool definition to getClaudeTools() for optimal Claude tool selection.

  Add to the tools array:
  ```typescript
  {
    name: 'web_search',
    description: "Search the web for current information. Use this when users ask to search for something, look something up, google something, or need up-to-date information that may not be in your training data. Examples: 'search for weather in NYC', 'look up the latest news about X', 'google how to do Y'.",
    input_schema: {
      type: 'object',
      properties: {
        query: {
          type: 'string',
          description: 'The search query - what to search for',
        },
        limit: {
          type: 'number',
          description: 'Maximum results to return (1-20, default 5)',
        },
      },
      required: ['query'],
    },
  },
  ```
  </action>
  <verify>
  ```bash
  grep -n "web_search" /root/jarvis-backend/src/ai/tools.ts
  ```
  </verify>
  <done>
  - web_search tool definition added to getClaudeTools()
  - Description guides Claude on when to use the tool
  </done>
</task>

<task type="auto">
  <name>Task 7: Add web keywords to router</name>
  <files>jarvis-backend/src/ai/router.ts</files>
  <action>
  Add web-related keywords and patterns to the router so web queries route to Claude.

  Add to ACTION_KEYWORDS array:
  ```typescript
  'search',
  'google',
  'look up',
  'browse',
  ```

  Add new entity pattern in ENTITY_PATTERNS array:
  ```typescript
  /\b(search|google|bing|duckduckgo|look\s*up)\b/i,
  ```

  This ensures queries like "search for X" or "google Y" route to Claude.
  </action>
  <verify>
  ```bash
  grep -n "'search'\|'google'\|'look up'\|'browse'" /root/jarvis-backend/src/ai/router.ts
  ```
  </verify>
  <done>
  - search, google, look up, browse added to ACTION_KEYWORDS
  - Web search pattern added to ENTITY_PATTERNS
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the full deployment works:

1. **Build and deploy:**
   ```bash
   cd /root && docker compose up -d --build
   ```

2. **Wait for containers to start:**
   ```bash
   sleep 30 && docker compose ps
   ```

3. **Verify SearXNG is running:**
   ```bash
   docker compose exec jarvis-backend curl -s "http://jarvis-searxng:8080/search?q=test&format=json" | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Results: {len(d.get(\"results\", []))}')"
   ```

4. **Check backend logs for web tool registration:**
   ```bash
   docker compose logs jarvis-backend 2>&1 | grep -i "web\|searx" | tail -5
   ```

5. **Test via chat (manual):**
   Open http://192.168.1.50:3004 and ask "search for weather in New York"
</verification>

<success_criteria>
1. SearXNG container running and healthy
2. web_search tool registered in MCP server
3. web_search is GREEN tier (auto-execute)
4. Router routes "search for X" queries to Claude
5. TypeScript compiles without errors
6. Docker Compose config validates
7. Search queries return results from SearXNG
</success_criteria>

<output>
After completion, create `.planning/phases/32-web-browsing-video-playback/32-01-SUMMARY.md`
</output>
