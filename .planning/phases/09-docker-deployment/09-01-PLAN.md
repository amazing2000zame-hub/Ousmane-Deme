# Plan 09-01: Docker Compose Full Stack + Nginx Reverse Proxy

## Goal
Finalize Docker Compose to deploy both backend and frontend containers with nginx reverse-proxying API/WebSocket traffic to the backend.

## Requirements Addressed
DOCK-01 (docker compose up), DOCK-02 (data persistence), DOCK-03 (SSH key mount), DOCK-05 (graceful shutdown), DOCK-06 (nginx proxy), DOCK-07 (WebSocket support)

## Files to Modify

### 1. `docker-compose.yml`
- Uncomment frontend service
- Set frontend port to 3004:80
- Add all missing env vars to backend (ANTHROPIC_API_KEY, JARVIS_OVERRIDE_KEY, LOCAL_LLM_ENDPOINT, CORS origins for 192.168.1.65:3004)
- Mount `known_hosts` for SSH host verification
- Add `stop_grace_period: 15s` for SQLite WAL checkpoint
- Add VITE_BACKEND_URL build arg for frontend

### 2. `jarvis-ui/nginx.conf`
- Add reverse proxy for `/api/` → `http://jarvis-backend:4000/api/`
- Add reverse proxy for `/socket.io/` → `http://jarvis-backend:4000/socket.io/` with WebSocket upgrade
- Frontend no longer needs CORS since everything goes through nginx on same origin

### 3. `jarvis-ui/Dockerfile`
- Accept `VITE_BACKEND_URL` as build arg
- Use `package-lock.json` for deterministic installs (`npm ci` instead of `npm install`)
- Add `.dockerignore`

### 4. `jarvis-backend/Dockerfile`
- Add `STOPSIGNAL SIGTERM` for graceful shutdown
- Copy `.env` template if needed

## Files to Create

### 5. `jarvis-ui/.dockerignore`
```
node_modules
dist
.git
*.md
```

### 6. `.env.production`
Template for production deployment on management VM.

## Verification
- [ ] `docker compose config` validates without errors
- [ ] Frontend container builds and serves on port 3004
- [ ] Backend container builds and runs on port 4000
- [ ] Nginx proxies /api/* to backend
- [ ] WebSocket connections work through nginx proxy
- [ ] SQLite data persists in named volume across restarts
