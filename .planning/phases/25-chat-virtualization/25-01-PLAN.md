# Phase 25-01: Virtual Scrolling with react-window

**Goal:** Replace flat message list with VariableSizeList, preserving all existing functionality

---

## Observable Truths

1. ChatPanel uses react-window VariableSizeList instead of flat messages.map
2. Only 10-15 ChatMessage components render at once (visible + overscan)
3. Scrolling through 100 messages maintains 60 FPS
4. Auto-scroll to bottom works when new messages arrive
5. Manual scroll-up prevents auto-scroll (userScrolledUpRef logic preserved)
6. Streaming content displays correctly
7. Variable-height messages render without layout shifts
8. Empty state renders when no messages
9. Smooth scrolling animation works
10. Message heights are measured and cached

---

## Implementation Tasks

### Task 1: Install Dependencies
- Add react-window to package.json
- Run npm install in jarvis-ui

### Task 2: Create Height Tracking Hook
- File: jarvis-ui/src/hooks/useMessageHeights.ts (NEW)
- Provides estimate(), get(), set(), clear() methods
- Caches measured heights in Map

### Task 3: Create Smooth Scroll Hook  
- File: jarvis-ui/src/hooks/useSmoothScroll.ts (NEW)
- Uses requestAnimationFrame for smooth animation
- Implements easeOutCubic easing function

### Task 4: Refactor ChatPanel
- File: jarvis-ui/src/components/center/ChatPanel.tsx
- Replace flat list with VariableSizeList
- Add ResizeObserver for container height
- Update auto-scroll to use scrollToItem
- Create Row renderer with height measurement

### Task 5: Testing
- Generate 150 test messages  
- Verify 60 FPS scrolling
- Test auto-scroll and manual scroll
- Verify streaming and empty state

---

## Files Summary

| File | Type | Purpose |
|------|------|---------|
| jarvis-ui/package.json | Modified | Add dependencies |
| jarvis-ui/src/hooks/useMessageHeights.ts | New | Height tracking |
| jarvis-ui/src/hooks/useSmoothScroll.ts | New | Smooth scroll |
| jarvis-ui/src/components/center/ChatPanel.tsx | Modified | Virtual list |

**Bundle size impact:** +34KB gzipped

---

**Plan Complete:** 2026-01-28
**Next Step:** Begin implementation
