---
phase: 30-mcp-reliability-voice-ack
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - jarvis-backend/src/realtime/chat.ts
  - jarvis-ui/src/hooks/useChatSocket.ts
  - jarvis-ui/src/audio/progressive-queue.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User hears acknowledgment phrase BEFORE tool results appear in UI"
    - "Acknowledgment plays immediately, not queued behind response audio"
    - "Acknowledgment works even when no response text has started streaming"
    - "Piper TTS is used for acknowledgments to ensure instant synthesis (<200ms)"
  artifacts:
    - path: "jarvis-backend/src/realtime/chat.ts"
      provides: "Dedicated chat:acknowledge event, Piper preference for acks"
      contains: "chat:acknowledge"
    - path: "jarvis-ui/src/hooks/useChatSocket.ts"
      provides: "Handler for chat:acknowledge event"
      contains: "onAcknowledge"
    - path: "jarvis-ui/src/audio/progressive-queue.ts"
      provides: "playAcknowledgmentImmediate function"
      exports: ["playAcknowledgmentImmediate"]
  key_links:
    - from: "jarvis-backend/src/realtime/chat.ts"
      to: "frontend via Socket.IO"
      via: "chat:acknowledge event"
      pattern: "socket\\.emit\\('chat:acknowledge'"
    - from: "jarvis-ui/src/hooks/useChatSocket.ts"
      to: "jarvis-ui/src/audio/progressive-queue.ts"
      via: "playAcknowledgmentImmediate call"
      pattern: "playAcknowledgmentImmediate"
---

<objective>
Fix voice acknowledgment timing so users hear "One moment, sir" BEFORE tool execution begins.

Purpose: The current implementation sends acknowledgment audio with index=-1 via chat:audio_chunk, but the frontend's progressive queue doesn't handle this correctly. Acknowledgments get queued or dropped because the progressive session hasn't started yet. This plan introduces a dedicated chat:acknowledge event with immediate playback, bypassing the progressive queue entirely.

Output: Working acknowledgment flow where JARVIS speaks before every tool execution, using Piper TTS for instant synthesis.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/30-mcp-reliability-voice-ack/30-RESEARCH.md

# Key source files
@jarvis-backend/src/realtime/chat.ts
@jarvis-backend/src/ai/tts.ts
@jarvis-ui/src/hooks/useChatSocket.ts
@jarvis-ui/src/audio/progressive-queue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add immediate acknowledgment playback function to progressive-queue.ts</name>
  <files>jarvis-ui/src/audio/progressive-queue.ts</files>
  <action>
Add a new exported function `playAcknowledgmentImmediate()` that plays audio immediately without queuing:

```typescript
/**
 * Play acknowledgment audio immediately, bypassing the progressive queue.
 * Used for tool acknowledgments that must play before any response audio.
 * Does NOT interfere with progressive sessions - uses same AudioContext.
 */
export async function playAcknowledgmentImmediate(
  audioData: ArrayBuffer,
  contentType: string,
): Promise<void> {
  const voiceState = useVoiceStore.getState();
  if (!voiceState.enabled || !voiceState.autoPlay) return;

  try {
    const { ctx, gainNode } = getSharedAudioContext();
    const volume = voiceState.volume;
    gainNode.gain.value = volume;

    // Decode the audio buffer
    const audioBuffer = await ctx.decodeAudioData(audioData.slice(0));

    // Create and play source immediately
    const source = ctx.createBufferSource();
    source.buffer = audioBuffer;
    source.connect(gainNode);
    source.start(0); // Play NOW, not scheduled

    // Don't wait for playback to complete - fire and forget
  } catch (err) {
    console.warn('[ProgressiveAudio] Failed to play acknowledgment:', err);
  }
}
```

This function:
- Uses the same shared AudioContext (getSharedAudioContext)
- Respects voice settings (enabled, autoPlay, volume)
- Plays immediately with start(0), not scheduled
- Does NOT block - returns after starting playback
- Does NOT interfere with progressive queue state
  </action>
  <verify>TypeScript compiles without errors: `cd /root/jarvis-ui && npm run build 2>&1 | head -30`</verify>
  <done>playAcknowledgmentImmediate is exported and callable</done>
</task>

<task type="auto">
  <name>Task 2: Add chat:acknowledge handler to useChatSocket.ts</name>
  <files>jarvis-ui/src/hooks/useChatSocket.ts</files>
  <action>
Add a new event handler for chat:acknowledge that plays audio immediately:

1. Import the new function at the top:
```typescript
import {
  startProgressiveSession,
  queueAudioChunk,
  markStreamDone,
  stopProgressive,
  playAcknowledgmentImmediate,  // Add this
} from '../audio/progressive-queue';
```

2. Add the handler function inside the useEffect, after onCloseLiveFeed:
```typescript
// Handle voice acknowledgment (plays immediately before tool execution)
function onAcknowledge(data: {
  sessionId: string;
  phrase: string;
  contentType: string;
  audio: string;  // base64 encoded
}) {
  console.log('[Chat] Received acknowledgment:', data.phrase);

  // Decode base64 to ArrayBuffer
  const binaryString = atob(data.audio);
  const bytes = new Uint8Array(binaryString.length);
  for (let i = 0; i < binaryString.length; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }

  // Play immediately, don't wait
  playAcknowledgmentImmediate(bytes.buffer, data.contentType);
}
```

3. Register the event listener after chat:close_live_feed:
```typescript
socket.on('chat:acknowledge', onAcknowledge);
```

4. Clean up in the return function:
```typescript
socket.off('chat:acknowledge', onAcknowledge);
```

Note: The onAudioChunk handler stays unchanged - it still handles response audio. The acknowledgment flow is completely separate.
  </action>
  <verify>TypeScript compiles without errors: `cd /root/jarvis-ui && npm run build 2>&1 | head -30`</verify>
  <done>chat:acknowledge handler registered and decodes base64 audio for immediate playback</done>
</task>

<task type="auto">
  <name>Task 3: Update sendToolAcknowledgment to use dedicated event and prefer Piper</name>
  <files>jarvis-backend/src/realtime/chat.ts</files>
  <action>
Modify the `sendToolAcknowledgment()` function to:
1. Use the new chat:acknowledge event type
2. Force Piper engine for instant synthesis (engineLock: 'piper')

Replace the existing sendToolAcknowledgment function (around line 86-107) with:

```typescript
/**
 * Synthesize and send an acknowledgment phrase immediately.
 * Used to give voice feedback before long-running tool calls.
 *
 * Uses Piper TTS (not XTTS) for instant synthesis (<200ms).
 * Sends via dedicated chat:acknowledge event for immediate playback.
 */
async function sendToolAcknowledgment(
  socket: Socket,
  sessionId: string,
  voiceMode: boolean,
): Promise<void> {
  if (!voiceMode || !ttsAvailable()) return;

  const phrase = getNextAckPhrase();
  try {
    // Force Piper for instant synthesis - XTTS takes 7-15s even for short phrases
    const audio = await synthesizeSentenceWithFallback(phrase, { engineLock: 'piper' });
    if (audio) {
      // Use dedicated event for immediate playback (not queued with response audio)
      socket.emit('chat:acknowledge', {
        sessionId,
        phrase,
        contentType: audio.contentType,
        audio: audio.buffer.toString('base64'),
      });
      console.log(`[Chat] Sent acknowledgment: "${phrase}" via Piper`);
    }
  } catch (err) {
    // Non-critical, continue without acknowledgment
    console.warn(`[Chat] Acknowledgment failed: ${err instanceof Error ? err.message : err}`);
  }
}
```

Also update the import at the top of the file to include synthesizeSentenceWithFallback (it's already imported, just verify it includes the options type).

The key changes:
- Uses `engineLock: 'piper'` to force fast synthesis
- Emits `chat:acknowledge` instead of `chat:audio_chunk`
- Includes the phrase text for debugging
- Logs the acknowledgment for observability
  </action>
  <verify>TypeScript compiles without errors: `cd /root/jarvis-backend && npm run build 2>&1 | head -30`</verify>
  <done>sendToolAcknowledgment uses chat:acknowledge event and forces Piper TTS</done>
</task>

</tasks>

<verification>
1. Build both projects without TypeScript errors:
   - `cd /root/jarvis-backend && npm run build`
   - `cd /root/jarvis-ui && npm run build`

2. Verify the acknowledgment event is emitted:
   - Start the backend: `cd /root && docker compose up -d --build`
   - Check logs for acknowledgment messages: `docker logs jarvis-backend 2>&1 | grep -i acknowledge`

3. Integration test (manual):
   - Open Jarvis UI at http://192.168.1.50:3004
   - Enable voice mode (speaker icon)
   - Ask: "What's the cluster status?"
   - Expected: Hear "One moment, sir" (or similar) BEFORE seeing tool execution results
</verification>

<success_criteria>
1. chat:acknowledge event is emitted by backend with base64 audio
2. Frontend receives and plays acknowledgment immediately
3. Acknowledgment plays BEFORE chat:tool_use event is processed by UI
4. Piper TTS is used (synthesis < 200ms, not 7-15s XTTS)
5. No TypeScript compilation errors in either project
</success_criteria>

<output>
After completion, create `.planning/phases/30-mcp-reliability-voice-ack/30-01-SUMMARY.md`
</output>
