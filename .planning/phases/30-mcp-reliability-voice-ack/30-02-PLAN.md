---
phase: 30-mcp-reliability-voice-ack
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - jarvis-backend/src/ai/loop.ts
  - jarvis-backend/src/mcp/server.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Tool execution times out after 60 seconds with user-friendly error message"
    - "Timeout errors are reported to user via chat:tool_result with isError=true"
    - "Claude receives timeout error and can acknowledge it in response"
    - "Hung tools don't block the conversation indefinitely"
  artifacts:
    - path: "jarvis-backend/src/ai/loop.ts"
      provides: "Tool execution with timeout wrapper"
      contains: "TOOL_TIMEOUT_MS"
    - path: "jarvis-backend/src/mcp/server.ts"
      provides: "Enhanced error messages in executeTool"
      contains: "timed out"
  key_links:
    - from: "jarvis-backend/src/ai/loop.ts"
      to: "jarvis-backend/src/mcp/server.ts"
      via: "executeTool call with timeout"
      pattern: "Promise\\.race"
---

<objective>
Add tool execution timeout and improve error handling for MCP tools.

Purpose: Currently, executeTool() has no timeout. Individual tool handlers may timeout (SSH has 30s default), but a hung tool can block the conversation indefinitely. This plan adds a 60-second timeout wrapper around all tool executions with graceful error messages.

Output: Reliable tool execution with timeout protection and user-friendly error reporting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/30-mcp-reliability-voice-ack/30-RESEARCH.md

# Key source files
@jarvis-backend/src/ai/loop.ts
@jarvis-backend/src/mcp/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add executeToolWithTimeout wrapper in loop.ts</name>
  <files>jarvis-backend/src/ai/loop.ts</files>
  <action>
Add a timeout wrapper function and update the tool execution calls to use it.

1. Add the timeout constant and wrapper function after the imports (around line 20):

```typescript
// ---------------------------------------------------------------------------
// Tool execution timeout
// ---------------------------------------------------------------------------

/** Maximum time (ms) for any tool to execute. Most tools complete in <30s.
 *  This timeout prevents hung tools from blocking conversations indefinitely. */
const TOOL_TIMEOUT_MS = 60_000;

/**
 * Execute a tool with timeout protection.
 * Returns a user-friendly error message on timeout instead of hanging.
 */
async function executeToolWithTimeout(
  name: string,
  args: Record<string, unknown>,
  source: 'llm' | 'monitor' | 'user' | 'api' = 'llm',
  overrideActive: boolean = false,
): Promise<{
  content: Array<{ type: string; text: string }>;
  isError?: boolean;
  blocked?: boolean;
  reason?: string;
  tier?: string;
}> {
  const timeoutPromise = new Promise<never>((_, reject) => {
    setTimeout(() => {
      reject(new Error(`Tool "${name}" timed out after ${TOOL_TIMEOUT_MS / 1000} seconds. The operation may still be running in the background.`));
    }, TOOL_TIMEOUT_MS);
  });

  try {
    return await Promise.race([
      executeTool(name, args, source, overrideActive),
      timeoutPromise,
    ]);
  } catch (err) {
    const errorMessage = err instanceof Error ? err.message : String(err);
    const isTimeout = errorMessage.includes('timed out');

    return {
      content: [{
        type: 'text',
        text: isTimeout
          ? `I'm sorry, the ${name} operation took too long (over 60 seconds) and was cancelled. This might indicate the service is unresponsive. You can try again or ask me to check the service status.`
          : `Tool "${name}" failed: ${errorMessage}`,
      }],
      isError: true,
    };
  }
}
```

2. Update the tool execution in runAgenticLoop (around line 175-206) to use the wrapper:

Change:
```typescript
const toolResult = await executeTool(
  block.name,
  block.input as Record<string, unknown>,
  'llm',
  overrideActive,
);
```

To:
```typescript
const toolResult = await executeToolWithTimeout(
  block.name,
  block.input as Record<string, unknown>,
  'llm',
  overrideActive,
);
```

This is the only place in runAgenticLoop where executeTool is called directly (around line 176).
  </action>
  <verify>TypeScript compiles: `cd /root/jarvis-backend && npm run build 2>&1 | head -30`</verify>
  <done>executeToolWithTimeout wraps all tool calls with 60s timeout</done>
</task>

<task type="auto">
  <name>Task 2: Update resumeAfterConfirmation to use timeout wrapper</name>
  <files>jarvis-backend/src/ai/loop.ts</files>
  <action>
The `resumeAfterConfirmation` function also calls executeTool directly. Update it to use the timeout wrapper.

In the resumeAfterConfirmation function (around line 263-276), change:

```typescript
const toolResult = await executeTool(
  pending.toolName,
  { ...pending.toolInput, confirmed: true },
  'llm',
);
```

To:

```typescript
const toolResult = await executeToolWithTimeout(
  pending.toolName,
  { ...pending.toolInput, confirmed: true },
  'llm',
  false, // overrideActive - confirmed RED tier doesn't need override
);
```

This ensures confirmed RED-tier tools also have timeout protection.
  </action>
  <verify>TypeScript compiles: `cd /root/jarvis-backend && npm run build 2>&1 | head -30`</verify>
  <done>Confirmed tool executions also have timeout protection</done>
</task>

<task type="auto">
  <name>Task 3: Add timeout logging and improve error messages in server.ts</name>
  <files>jarvis-backend/src/mcp/server.ts</files>
  <action>
Enhance executeTool() to log execution times and provide better error context.

1. Add a helper to format duration (near the top of the file, after imports):

```typescript
/** Format milliseconds as human-readable duration */
function formatDuration(ms: number): string {
  if (ms < 1000) return `${ms}ms`;
  if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
  return `${Math.floor(ms / 60000)}m ${Math.floor((ms % 60000) / 1000)}s`;
}
```

2. In the executeTool function, update the logging in Step 5 (around line 213-231) to include more detail:

Change the summary line from:
```typescript
summary: `${result.isError ? 'FAILED' : 'OK'}: ${name} (${safety.tier}) [${durationMs}ms]`,
```

To:
```typescript
summary: `${result.isError ? 'FAILED' : 'OK'}: ${name} (${safety.tier}) [${formatDuration(durationMs)}]`,
```

3. Add a warning log for slow tools (after the memoryStore.saveEvent block, around line 229):

```typescript
// Warn about slow tools (over 10 seconds)
if (durationMs > 10_000) {
  console.warn(`[MCP] Slow tool execution: ${name} took ${formatDuration(durationMs)}`);
}
```

4. Enhance the error handling in Step 4 (around line 198-210) to include more context:

The existing catch block is:
```typescript
} catch (err) {
  result = {
    content: [{
      type: 'text',
      text: `Tool "${name}" execution failed: ${err instanceof Error ? err.message : String(err)}`,
    }],
    isError: true,
  };
}
```

Update it to:
```typescript
} catch (err) {
  const errorMsg = err instanceof Error ? err.message : String(err);
  console.error(`[MCP] Tool execution error: ${name} - ${errorMsg}`);
  result = {
    content: [{
      type: 'text',
      text: `Tool "${name}" execution failed: ${errorMsg}`,
    }],
    isError: true,
  };
}
```

This adds console logging for errors which helps with debugging.
  </action>
  <verify>TypeScript compiles: `cd /root/jarvis-backend && npm run build 2>&1 | head -30`</verify>
  <done>Better error messages and slow tool warnings in place</done>
</task>

</tasks>

<verification>
1. Build the backend without TypeScript errors:
   - `cd /root/jarvis-backend && npm run build`

2. Verify timeout behavior (unit test approach):
   - The timeout is set to 60 seconds, which is hard to test manually
   - Verify the code path by reviewing that executeToolWithTimeout is called

3. Integration test (manual):
   - Start the backend: `cd /root && docker compose up -d --build`
   - Ask Jarvis to execute a tool: "What's the cluster status?"
   - Watch logs: `docker logs -f jarvis-backend 2>&1 | grep -E "(MCP|Tool)"`
   - Verify execution times are logged

4. Error handling test (manual):
   - Ask Jarvis to do something that might fail
   - Verify the error message is user-friendly, not a stack trace
</verification>

<success_criteria>
1. executeToolWithTimeout wrapper exists and is used for all tool calls
2. 60-second timeout returns user-friendly error message
3. Slow tools (>10s) generate warning logs
4. Error messages are human-readable, not stack traces
5. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/30-mcp-reliability-voice-ack/30-02-SUMMARY.md`
</output>
