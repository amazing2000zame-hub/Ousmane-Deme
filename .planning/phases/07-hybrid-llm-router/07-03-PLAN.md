# Plan 07-03: Provider Badge + Cost Dashboard

## Objective

Build frontend UI components for provider visibility (badge on chat messages) and cost analytics (dashboard panel showing daily/weekly/monthly spend), enabling users to monitor LLM usage and costs in real-time.

**Purpose**: Complete the hybrid LLM user experience with transparent provider indicators and cost visibility, validating the cost savings hypothesis (60-85% reduction).

**Output**: Chat interface shows which LLM generated each message, dashboard displays cost metrics updated in real-time.

## Requirements Addressed

- ROUTE-02: Automatic fallback to Qwen notification (visible in provider badge)
- ROUTE-03: Provider indicator in chat UI (badge showing Claude/Qwen)
- ROUTE-05: Cost tracking dashboard panel (daily/weekly/monthly)

## Files to Modify

### `/root/jarvis-ui/src/types/chat.ts`
- **Add**: `provider` field to `ChatMessage` interface:
  ```typescript
  export interface ChatMessage {
    role: 'user' | 'assistant' | 'system';
    content: string;
    toolCalls?: ToolCall[];
    provider?: 'claude' | 'qwen'; // NEW
  }
  ```

### `/root/jarvis-ui/src/stores/chat.ts`
- **Add**: `provider` field to message state
- **Update**: `addMessage()` to accept provider parameter
- **Update**: Socket event handlers to extract provider from events

### `/root/jarvis-ui/src/hooks/useChatSocket.ts`
- **Update**: `chat:done` event handler to extract provider from payload:
  ```typescript
  socket.on('chat:done', (data: { sessionId: string; usage: Usage; provider?: string }) => {
    const { provider } = data;
    // Update last assistant message with provider
    chatStore.updateLastMessageProvider(provider || 'unknown');
  });
  ```
- **Add**: Fallback notification when provider switches from Claude to Qwen:
  ```typescript
  if (previousProvider === 'claude' && currentProvider === 'qwen') {
    // Show toast notification
  }
  ```

### `/root/jarvis-ui/src/components/center/ChatInterface.tsx`
- **Import**: `ProviderBadge` component
- **Update**: Message rendering to include provider badge:
  ```tsx
  {message.role === 'assistant' && message.provider && (
    <ProviderBadge provider={message.provider} />
  )}
  ```

### `/root/jarvis-ui/src/components/right/Dashboard.tsx`
- **Import**: `CostPanel` component
- **Add**: CostPanel to right column layout (between existing panels)

## Files to Create

### `/root/jarvis-ui/src/components/center/ProviderBadge.tsx`
```tsx
/**
 * Provider badge for chat messages.
 * Shows which LLM generated the response (Claude or Qwen).
 */
import React from 'react';

interface ProviderBadgeProps {
  provider: 'claude' | 'qwen' | 'unknown';
}

export function ProviderBadge({ provider }: ProviderBadgeProps): JSX.Element {
  const config = {
    claude: {
      label: 'Claude Sonnet 4',
      color: '#D4A574', // Gold
      icon: 'ðŸ§ ',
    },
    qwen: {
      label: 'Qwen 2.5 7B',
      color: '#00D9FF', // Cyan
      icon: 'âš¡',
    },
    unknown: {
      label: 'Unknown',
      color: '#666',
      icon: '?',
    },
  };

  const { label, color, icon } = config[provider] || config.unknown;

  return (
    <div
      style={{
        display: 'inline-flex',
        alignItems: 'center',
        gap: '4px',
        padding: '2px 8px',
        borderRadius: '4px',
        border: `1px solid ${color}`,
        color,
        fontSize: '11px',
        fontFamily: 'Share Tech Mono, monospace',
        textTransform: 'uppercase',
        letterSpacing: '0.5px',
        marginLeft: '8px',
      }}
    >
      <span>{icon}</span>
      <span>{label}</span>
    </div>
  );
}
```

### `/root/jarvis-ui/src/components/right/CostPanel.tsx`
```tsx
/**
 * Cost tracking dashboard panel.
 * Shows daily/weekly/monthly LLM usage costs with provider breakdown.
 */
import React, { useEffect, useState } from 'react';
import { API_BASE } from '../../config';

interface CostSummary {
  period: string;
  total: number;
  summary: Array<{
    model: string;
    totalCost: number;
    totalInputTokens: number;
    totalOutputTokens: number;
    messageCount: number;
  }>;
}

interface BudgetStatus {
  dailyLimit: number;
  spent: number;
  remaining: number;
  percentUsed: number;
  exceeded: boolean;
}

export function CostPanel(): JSX.Element {
  const [period, setPeriod] = useState<'daily' | 'weekly' | 'monthly'>('daily');
  const [summary, setSummary] = useState<CostSummary | null>(null);
  const [budget, setBudget] = useState<BudgetStatus | null>(null);
  const [loading, setLoading] = useState(true);

  // Fetch cost summary
  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);
      try {
        const [summaryRes, budgetRes] = await Promise.all([
          fetch(`${API_BASE}/api/cost/summary?period=${period}`),
          fetch(`${API_BASE}/api/cost/budget`),
        ]);

        const summaryData = await summaryRes.json();
        const budgetData = await budgetRes.json();

        setSummary(summaryData);
        setBudget(budgetData);
      } catch (err) {
        console.error('[CostPanel] Failed to fetch cost data:', err);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    const interval = setInterval(fetchData, 30000); // Refresh every 30s
    return () => clearInterval(interval);
  }, [period]);

  if (loading || !summary || !budget) {
    return (
      <div className="panel cost-panel">
        <div className="panel-header">LLM COST TRACKER</div>
        <div className="panel-content">
          <div style={{ color: '#00D9FF', textAlign: 'center', padding: '20px' }}>
            LOADING...
          </div>
        </div>
      </div>
    );
  }

  const claudeData = summary.summary.find(s => s.model === 'claude');
  const qwenData = summary.summary.find(s => s.model === 'qwen');

  return (
    <div className="panel cost-panel">
      <div className="panel-header">LLM COST TRACKER</div>

      <div className="panel-content">
        {/* Period selector */}
        <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
          {(['daily', 'weekly', 'monthly'] as const).map(p => (
            <button
              key={p}
              onClick={() => setPeriod(p)}
              style={{
                flex: 1,
                padding: '4px 8px',
                background: period === p ? '#00D9FF' : 'transparent',
                border: '1px solid #00D9FF',
                color: period === p ? '#000' : '#00D9FF',
                fontFamily: 'Share Tech Mono, monospace',
                fontSize: '10px',
                textTransform: 'uppercase',
                cursor: 'pointer',
              }}
            >
              {p}
            </button>
          ))}
        </div>

        {/* Daily budget status (only show for daily period) */}
        {period === 'daily' && (
          <div style={{ marginBottom: '16px', padding: '12px', border: '1px solid #00D9FF' }}>
            <div style={{ fontSize: '11px', color: '#00D9FF', marginBottom: '8px' }}>
              DAILY BUDGET
            </div>
            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
              <span style={{ fontSize: '10px', color: '#888' }}>Spent:</span>
              <span style={{ fontSize: '10px', color: budget.exceeded ? '#FF4444' : '#00D9FF' }}>
                ${budget.spent.toFixed(3)} / ${budget.dailyLimit.toFixed(2)}
              </span>
            </div>
            <div style={{ height: '4px', background: '#333', position: 'relative', overflow: 'hidden' }}>
              <div
                style={{
                  position: 'absolute',
                  left: 0,
                  top: 0,
                  height: '100%',
                  width: `${Math.min(budget.percentUsed, 100)}%`,
                  background: budget.exceeded ? '#FF4444' : '#00D9FF',
                  transition: 'width 0.3s ease',
                }}
              />
            </div>
            {budget.exceeded && (
              <div style={{ fontSize: '9px', color: '#FF4444', marginTop: '4px' }}>
                âš  BUDGET EXCEEDED - Auto-fallback to Qwen
              </div>
            )}
          </div>
        )}

        {/* Total cost */}
        <div style={{ marginBottom: '16px', textAlign: 'center' }}>
          <div style={{ fontSize: '11px', color: '#888', marginBottom: '4px' }}>
            TOTAL {period.toUpperCase()} COST
          </div>
          <div style={{ fontSize: '24px', color: '#D4A574', fontWeight: 'bold' }}>
            ${summary.total.toFixed(3)}
          </div>
        </div>

        {/* Provider breakdown */}
        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
          {/* Claude */}
          {claudeData && (
            <div style={{ padding: '8px', border: '1px solid #D4A574' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                <span style={{ fontSize: '10px', color: '#D4A574' }}>ðŸ§  CLAUDE SONNET 4</span>
                <span style={{ fontSize: '10px', color: '#D4A574', fontWeight: 'bold' }}>
                  ${claudeData.totalCost.toFixed(3)}
                </span>
              </div>
              <div style={{ fontSize: '9px', color: '#666' }}>
                {claudeData.messageCount} messages â€¢ {(claudeData.totalInputTokens / 1000).toFixed(1)}K in â€¢ {(claudeData.totalOutputTokens / 1000).toFixed(1)}K out
              </div>
            </div>
          )}

          {/* Qwen */}
          {qwenData && (
            <div style={{ padding: '8px', border: '1px solid #00D9FF' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                <span style={{ fontSize: '10px', color: '#00D9FF' }}>âš¡ QWEN 2.5 7B</span>
                <span style={{ fontSize: '10px', color: '#00D9FF', fontWeight: 'bold' }}>
                  FREE
                </span>
              </div>
              <div style={{ fontSize: '9px', color: '#666' }}>
                {qwenData.messageCount} messages â€¢ {(qwenData.totalOutputTokens / 1000).toFixed(1)}K tokens
              </div>
            </div>
          )}
        </div>

        {/* Savings estimate */}
        {claudeData && qwenData && (
          <div style={{ marginTop: '16px', padding: '8px', background: '#1a1a1a', border: '1px solid #00D9FF' }}>
            <div style={{ fontSize: '9px', color: '#888', marginBottom: '4px' }}>
              ESTIMATED SAVINGS vs Claude-only
            </div>
            <div style={{ fontSize: '14px', color: '#00FF00' }}>
              {(() => {
                const totalMessages = claudeData.messageCount + qwenData.messageCount;
                const claudePercentage = (claudeData.messageCount / totalMessages) * 100;
                const savingsPercentage = 100 - claudePercentage;
                return `${savingsPercentage.toFixed(0)}%`;
              })()}
            </div>
            <div style={{ fontSize: '8px', color: '#666', marginTop: '2px' }}>
              {qwenData.messageCount} messages routed to local Qwen
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
```

### `/root/jarvis-ui/src/components/right/CostPanel.css`
```css
.cost-panel {
  background: rgba(0, 0, 0, 0.7);
  border: 1px solid #00D9FF;
  border-radius: 4px;
  padding: 12px;
  font-family: 'Share Tech Mono', monospace;
  margin-bottom: 16px;
}

.cost-panel .panel-header {
  font-size: 12px;
  color: #00D9FF;
  margin-bottom: 12px;
  letter-spacing: 1px;
  text-align: center;
  border-bottom: 1px solid #00D9FF;
  padding-bottom: 8px;
}

.cost-panel .panel-content {
  font-size: 11px;
}
```

## Implementation Steps

### Step 1: Update TypeScript types
1. Add `provider` field to `ChatMessage` interface in `types/chat.ts`
2. Make it optional (`provider?: 'claude' | 'qwen'`) for backward compatibility
3. Export type for use in components

### Step 2: Update chat store
1. Add `provider` to message state in `stores/chat.ts`
2. Update `addMessage()` to accept provider parameter
3. Add `updateLastMessageProvider()` helper method:
   ```typescript
   updateLastMessageProvider(provider: string) {
     const messages = get().messages;
     if (messages.length === 0) return;

     const lastMessage = messages[messages.length - 1];
     if (lastMessage.role === 'assistant') {
       lastMessage.provider = provider as 'claude' | 'qwen';
       set({ messages: [...messages] });
     }
   }
   ```

### Step 3: Update Socket.IO hook
1. Modify `useChatSocket.ts` to extract provider from `chat:done` event
2. Call `chatStore.updateLastMessageProvider()` when received
3. Add fallback detection logic:
   ```typescript
   const [lastProvider, setLastProvider] = useState<string | null>(null);

   socket.on('chat:done', (data) => {
     const provider = data.provider || 'unknown';

     // Detect Claude â†’ Qwen fallback
     if (lastProvider === 'claude' && provider === 'qwen') {
       // Show toast notification (if toast library available)
       console.log('[Chat] Fallback to Qwen detected (Claude unavailable or budget exceeded)');
     }

     chatStore.updateLastMessageProvider(provider);
     setLastProvider(provider);
   });
   ```

### Step 4: Create ProviderBadge component
1. Create `src/components/center/ProviderBadge.tsx`
2. Style as inline badge with provider-specific colors:
   - Claude: Gold (#D4A574) with ðŸ§  icon
   - Qwen: Cyan (#00D9FF) with âš¡ icon
3. Use Share Tech Mono font for consistency with dashboard theme
4. Keep badge small and unobtrusive (11px font, minimal padding)

### Step 5: Integrate badge into ChatInterface
1. Import `ProviderBadge` in `ChatInterface.tsx`
2. Render badge next to assistant messages:
   ```tsx
   {message.role === 'assistant' && (
     <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
       <span>{message.content}</span>
       {message.provider && <ProviderBadge provider={message.provider} />}
     </div>
   )}
   ```
3. Ensure badge doesn't disrupt message layout

### Step 6: Create CostPanel component
1. Create `src/components/right/CostPanel.tsx` with period selector (daily/weekly/monthly)
2. Fetch data from `/api/cost/summary` and `/api/cost/budget` endpoints
3. Display total cost prominently
4. Show provider breakdown (Claude vs Qwen)
5. Show daily budget status with progress bar (only for daily period)
6. Calculate and display savings percentage
7. Auto-refresh every 30 seconds

### Step 7: Create CostPanel styles
1. Create `src/components/right/CostPanel.css` matching eDEX-UI theme
2. Use cyan (#00D9FF) and gold (#D4A574) accent colors
3. Match existing panel styling (transparent black background, monospace font)

### Step 8: Integrate CostPanel into Dashboard
1. Import `CostPanel` in `Dashboard.tsx`
2. Add to right column layout:
   ```tsx
   <div className="right-column">
     <QuorumIndicator />
     <CostPanel />  {/* NEW */}
     {/* Other panels */}
   </div>
   ```
3. Ensure panel fits within existing layout

## Verification

### Test 1: Provider badge visibility
1. Open chat interface at http://192.168.1.65:3004
2. Send conversational message: "Hello, how are you?"
3. Verify assistant response shows "âš¡ QWEN 2.5 7B" badge in cyan
4. Send cluster command: "Show cluster status"
5. Verify assistant response shows "ðŸ§  CLAUDE SONNET 4" badge in gold
6. Badge should be inline, not disrupt layout

### Test 2: Fallback notification
1. Set very low budget: `DAILY_COST_LIMIT=0.01`
2. Send 1 Claude message (should work)
3. Send 2nd Claude message (should fallback to Qwen)
4. Check browser console for: "Fallback to Qwen detected"
5. Verify 2nd response has Qwen badge

### Test 3: Cost panel data display
1. Open dashboard at http://192.168.1.65:3004
2. Locate "LLM COST TRACKER" panel in right column
3. Verify panel shows:
   - Period selector (DAILY / WEEKLY / MONTHLY)
   - Total cost in large gold text
   - Claude breakdown with token counts
   - Qwen breakdown with message count
   - Savings percentage in green

### Test 4: Daily budget indicator
1. With `DAILY_COST_LIMIT=10.0`, send several Claude messages
2. Cost panel should show:
   - "DAILY BUDGET" section
   - Spent: $X.XXX / $10.00
   - Progress bar proportional to percentage
   - Green/cyan color (not exceeded)
3. If limit exceeded:
   - Progress bar turns red
   - "âš  BUDGET EXCEEDED" warning shows
   - "Auto-fallback to Qwen" message

### Test 5: Period switching
1. Click "WEEKLY" button in cost panel
2. Verify total updates to show 7-day cost
3. Click "MONTHLY" button
4. Verify total updates to show 30-day cost
5. Budget bar should only show for "DAILY" period

### Test 6: Real-time updates
1. Keep dashboard open
2. Send 3-4 chat messages via UI
3. Wait ~30 seconds (auto-refresh interval)
4. Verify cost panel updates without page reload:
   - Total cost increases
   - Message counts increase
   - Savings percentage recalculates

### Test 7: Savings calculation accuracy
```
Example scenario:
- 10 total messages
- 3 via Claude ($0.15)
- 7 via Qwen ($0.00)

Expected savings: 70%

All-Claude cost: 10 messages * $0.05 avg = $0.50
Hybrid cost: $0.15
Savings: ($0.50 - $0.15) / $0.50 = 70%
```

## Commit Message

```
feat(07-03): add provider badge to chat and cost dashboard panel

Build frontend UI for LLM provider transparency and cost visibility.
Add provider badges to chat messages (Claude gold, Qwen cyan) and
comprehensive cost tracking dashboard panel with daily/weekly/monthly
views and savings calculation.

Changes:
- Add provider field to ChatMessage type
- Create ProviderBadge component with Claude/Qwen indicators
- Update useChatSocket to extract provider from chat:done event
- Create CostPanel component with period selector and budget status
- Add /api/cost/* endpoint integration
- Display real-time cost totals and provider breakdown
- Show daily budget progress bar with auto-fallback warning
- Calculate savings percentage vs Claude-only baseline

UI features:
  - Provider badge on every assistant message
  - Period selector (daily/weekly/monthly)
  - Budget status with progress bar
  - Claude vs Qwen cost breakdown
  - Savings percentage display
  - Auto-refresh every 30s

Requirements: ROUTE-02, ROUTE-03, ROUTE-05

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```
