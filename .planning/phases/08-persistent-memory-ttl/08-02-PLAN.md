# Plan 08-02: Memory Extraction & Context Injection

## Goal
Automatically extract memories from chat sessions and cluster events, then inject relevant historical context into the system prompt within token budget limits.

## Requirements Addressed
MEM-01 (recall past conversations), MEM-02 (remember cluster events), MEM-03 (persist user preferences), MEM-04 (system prompt includes historical context within token budget)

## Files to Create

### 1. `jarvis-backend/src/ai/memory-extractor.ts`
Extracts memories from completed chat sessions and cluster events.

```typescript
/**
 * Called after each chat session completes (in onDone callback).
 * Analyzes the conversation and extracts:
 *   - Session summary (conversation tier, 7d TTL)
 *   - User preferences detected (semantic tier, permanent)
 *   - Cluster facts learned (episodic tier, 30d TTL)
 */
export function extractMemoriesFromSession(
  sessionId: string,
  messages: Array<{ role: string; content: string }>,
  provider: string
): void

/**
 * Called when a cluster event is saved (from monitoring/autonomous system).
 * Converts significant events into episodic memories.
 * Filters: only warning/error/critical severity, or resolved incidents.
 */
export function extractMemoryFromEvent(event: {
  type: string;
  severity: string;
  message: string;
  node?: string;
  resolved?: boolean;
}): void

/**
 * Detect user preferences from message text.
 * Patterns: "I prefer...", "always ...", "never ...", "remind me to...",
 *           "I like...", "don't ...", "use ... for ...", "my ... is ..."
 * Returns array of { key, content } or empty array.
 */
export function detectPreferences(message: string): Array<{ key: string; content: string }>
```

**Extraction rules:**
- Session summary: Take last user message + last assistant response, create 1-2 sentence summary. Key: `session_${sessionId}_summary`
- Preferences: Regex patterns for preference language → semantic tier, key: `pref_${topic}`
- Node events: Significant events (severity >= warning) → episodic tier, key: `event_${node}_${type}_${date}`
- Learned facts: Tool results that reveal cluster state → episodic tier, key: `fact_${topic}_${date}`

### 2. `jarvis-backend/src/ai/memory-context.ts`
Builds the memory context block for system prompt injection.

```typescript
/**
 * Builds a memory context string to inject into the system prompt.
 * Stays within the configured token budget (~600 tokens for Claude, ~200 for Qwen).
 *
 * Priority order:
 *   1. User preferences (semantic tier) - always included
 *   2. Recent cluster events related to current query (episodic tier)
 *   3. Recent session summaries (conversation tier)
 *
 * Uses rough token estimation: 1 token ≈ 4 characters.
 */
export function buildMemoryContext(
  userMessage: string,
  provider: 'claude' | 'qwen',
  maxTokens?: number
): string

/**
 * Search memories relevant to a user query.
 * Used when user asks recall questions ("what did we discuss", "do you remember").
 * Returns formatted string of matching memories with timestamps.
 */
export function recallMemories(query: string, limit?: number): string
```

**Context format:**
```
<memory_context>
<preferences>
- User prefers email alerts for critical issues
- Always check disk usage before storage operations
</preferences>
<recent_events>
- [2026-01-25] Node agent was offline for 2 hours (resolved: auto-restart)
- [2026-01-24] pve disk usage reached 85% on local-lvm
</recent_events>
<recent_conversations>
- [2026-01-25] Discussed pve storage optimization, recommended cleanup of old backups
- [2026-01-24] Configured daily status report email schedule
</recent_conversations>
</memory_context>
```

## Files to Modify

### 3. `jarvis-backend/src/ai/system-prompt.ts`
- Import `buildMemoryContext` from `./memory-context.js`
- In `buildClaudeSystemPrompt()`: call `buildMemoryContext(userMessage, 'claude')` and append after `<cluster_context>` block
- In `buildQwenSystemPrompt()`: call `buildMemoryContext(userMessage, 'qwen')` with smaller budget
- Both functions need new `userMessage` parameter to enable query-relevant memory retrieval
- Add instruction text: "You have persistent memory. Use the <memory_context> section to recall past events, preferences, and conversations. Reference specific memories when relevant."

**Signature changes:**
```typescript
// Before:
export function buildClaudeSystemPrompt(clusterSummary: string, overrideActive: boolean): string
export function buildQwenSystemPrompt(clusterSummary: string): string

// After:
export function buildClaudeSystemPrompt(clusterSummary: string, overrideActive: boolean, userMessage?: string): string
export function buildQwenSystemPrompt(clusterSummary: string, userMessage?: string): string
```

### 4. `jarvis-backend/src/realtime/chat.ts`
- Import `extractMemoriesFromSession` and `detectPreferences`
- In the `chat:send` handler, after saving the user message, call `detectPreferences(message)` and save any found immediately
- In the `onDone` callback, call `extractMemoriesFromSession()` with the session messages
- Pass `userMessage` through to system prompt builders

### 5. `jarvis-backend/src/services/monitor.ts` (or equivalent autonomous monitoring file)
- If events are generated by monitoring, call `extractMemoryFromEvent()` to persist them
- If no monitoring module exists, skip — extraction will happen via chat tool results

## Implementation Notes
- Memory extraction is **synchronous** (better-sqlite3) — no async overhead
- Preference detection uses simple regex, no LLM call (keep it fast and free)
- Token budget estimation: `Math.ceil(text.length / 4)` is good enough for rough budgeting
- Session summaries are intentionally brief (1-2 sentences) to stay within budget
- The `recallMemories()` function is for explicit recall queries, separate from the auto-context injection
- Memory context is rebuilt on every message (stateless, reads from DB each time)

## Verification
- [ ] After a chat session, a session summary memory is created in conversation tier
- [ ] Saying "I prefer email alerts" creates a semantic-tier preference memory
- [ ] System prompt includes `<memory_context>` block with relevant memories
- [ ] Memory context stays within token budget (≤600 tokens for Claude, ≤200 for Qwen)
- [ ] Cluster events of severity warning+ generate episodic memories
- [ ] Asking "what did we discuss yesterday" returns relevant session summaries
