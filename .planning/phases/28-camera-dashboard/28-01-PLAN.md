---
phase: 28-camera-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - jarvis-backend/src/api/camera.ts
  - jarvis-backend/src/api/routes.ts
  - jarvis-ui/src/stores/camera.ts
  - jarvis-ui/src/components/camera/CameraPanel.tsx
  - jarvis-ui/src/components/camera/CameraCard.tsx
  - jarvis-ui/src/components/camera/CameraModal.tsx
  - jarvis-ui/src/components/center/CenterDisplay.tsx
  - jarvis-ui/src/hooks/useCameraPolling.ts
autonomous: true

must_haves:
  truths:
    - "User can see a 2-camera snapshot grid in the dashboard CAM view"
    - "Snapshots refresh automatically every 10 seconds"
    - "User can click a camera to see full-size snapshot in modal"
    - "Modal closes via X button, backdrop click, or Escape key"
  artifacts:
    - path: "jarvis-backend/src/api/camera.ts"
      provides: "Frigate snapshot/thumbnail proxy routes"
      exports: ["cameraRouter"]
    - path: "jarvis-ui/src/stores/camera.ts"
      provides: "Camera state management"
      exports: ["useCameraStore"]
    - path: "jarvis-ui/src/components/camera/CameraPanel.tsx"
      provides: "Camera grid container"
      exports: ["CameraPanel"]
    - path: "jarvis-ui/src/components/camera/CameraCard.tsx"
      provides: "Individual camera snapshot card"
      exports: ["CameraCard"]
    - path: "jarvis-ui/src/components/camera/CameraModal.tsx"
      provides: "Full-size snapshot modal"
      exports: ["CameraModal"]
  key_links:
    - from: "jarvis-ui/src/stores/camera.ts"
      to: "/api/cameras/:camera/snapshot"
      via: "fetch in useCameraPolling"
      pattern: "fetch.*api/cameras"
    - from: "jarvis-ui/src/components/camera/CameraPanel.tsx"
      to: "useCameraStore"
      via: "Zustand selector"
      pattern: "useCameraStore"
    - from: "jarvis-ui/src/components/center/CenterDisplay.tsx"
      to: "CameraPanel"
      via: "tab navigation"
      pattern: "CameraPanel"
---

<objective>
Create backend API proxy routes for Frigate camera images and build the CameraPanel component with snapshot grid and click-to-enlarge modal.

Purpose: Users can view live camera snapshots in the Jarvis dashboard without leaving the UI, addressing CAM-01 and CAM-02 requirements.

Output: Backend camera API routes, camera Zustand store, CameraPanel/CameraCard/CameraModal components, and CAM tab in CenterDisplay.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-camera-dashboard/28-RESEARCH.md
@jarvis-backend/src/clients/frigate.ts
@jarvis-backend/src/api/routes.ts
@jarvis-ui/src/stores/cluster.ts
@jarvis-ui/src/components/center/CenterDisplay.tsx
@jarvis-ui/src/components/shared/ConfirmDialog.tsx
@jarvis-ui/src/components/layout/PanelFrame.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend camera API proxy routes</name>
  <files>
    jarvis-backend/src/api/camera.ts
    jarvis-backend/src/api/routes.ts
  </files>
  <action>
Create `jarvis-backend/src/api/camera.ts` with Express router that proxies Frigate image endpoints:

1. `GET /api/cameras` - Returns list of camera names from `getCameras()` in frigate.ts

2. `GET /api/cameras/:camera/snapshot` - Proxies latest snapshot:
   - Call `getLatestSnapshot(camera)` from frigate.ts
   - Add cache-busting by setting `Cache-Control: no-cache, no-store`
   - Return `Content-Type: image/jpeg`
   - Return Buffer directly with `res.send(buffer)`

3. `GET /api/events/:eventId/thumbnail` - Proxies event thumbnail:
   - Call `getEventThumbnail(eventId)` from frigate.ts
   - Set `Content-Type: image/jpeg`
   - Return Buffer directly

4. `GET /api/events/:eventId/snapshot` - Proxies full event snapshot:
   - Call `getEventSnapshot(eventId)` from frigate.ts
   - Set `Content-Type: image/jpeg`
   - Return Buffer directly

5. `GET /api/events` - Proxies events list with query params:
   - Pass through: camera, label, limit, after, before, has_snapshot
   - Call `getEvents()` from frigate.ts with parsed options
   - Return JSON array

Add error handling with try/catch returning 500 on Frigate errors, 404 if camera not found.

Register the router in routes.ts at `/api` prefix (routes already have /api built in).

Note: No authentication needed - this is LAN-only. CORS not needed since same origin.
  </action>
  <verify>
```bash
# Build backend
cd /root/jarvis-backend && npm run build

# Test endpoints (requires docker stack running)
curl -s http://localhost:4000/api/cameras | jq
curl -s -o /tmp/snap.jpg http://localhost:4000/api/cameras/front_door/snapshot && file /tmp/snap.jpg
curl -s "http://localhost:4000/api/events?limit=3&label=person" | jq '.[0:2]'
```
  </verify>
  <done>
All 5 camera API endpoints return correct data: /api/cameras returns camera names array, snapshot endpoints return valid JPEG images, events endpoint returns JSON array with Frigate event objects.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create camera Zustand store and polling hook</name>
  <files>
    jarvis-ui/src/stores/camera.ts
    jarvis-ui/src/hooks/useCameraPolling.ts
  </files>
  <action>
Create `jarvis-ui/src/stores/camera.ts` following cluster.ts patterns:

```typescript
interface CameraState {
  cameras: string[];                    // ['front_door', 'side_house']
  snapshots: Record<string, string>;    // camera -> blob URL
  selectedCamera: string | null;        // For modal
  modalOpen: boolean;
  lastRefresh: number;

  setCameras: (cameras: string[]) => void;
  setSnapshot: (camera: string, url: string) => void;
  openModal: (camera: string) => void;
  closeModal: () => void;
  revokeSnapshots: () => void;          // Cleanup blob URLs
}
```

Use `create` from zustand with `devtools` middleware. Name: 'camera-store'.

Key implementation details:
- `setSnapshot` should revoke old blob URL before setting new one (prevent memory leaks)
- `revokeSnapshots` should iterate all snapshots and call `URL.revokeObjectURL()`
- `closeModal` sets selectedCamera to null and modalOpen to false

Create `jarvis-ui/src/hooks/useCameraPolling.ts`:

```typescript
export function useCameraPolling(intervalMs = 10000) {
  const setCameras = useCameraStore(s => s.setCameras);
  const setSnapshot = useCameraStore(s => s.setSnapshot);
  const cameras = useCameraStore(s => s.cameras);
  const revokeSnapshots = useCameraStore(s => s.revokeSnapshots);

  // Initial load: fetch camera list
  useEffect(() => {
    fetch('/api/cameras')
      .then(r => r.json())
      .then(setCameras)
      .catch(console.error);
  }, [setCameras]);

  // Polling: fetch snapshots for each camera
  useEffect(() => {
    if (cameras.length === 0) return;

    async function refresh() {
      for (const camera of cameras) {
        try {
          const res = await fetch(`/api/cameras/${camera}/snapshot?t=${Date.now()}`);
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          setSnapshot(camera, url);
        } catch (e) {
          console.error(`Failed to fetch ${camera} snapshot:`, e);
        }
      }
    }

    refresh(); // Initial fetch
    const id = setInterval(refresh, intervalMs);
    return () => {
      clearInterval(id);
      revokeSnapshots();
    };
  }, [cameras, intervalMs, setSnapshot, revokeSnapshots]);
}
```

Use `?t=${Date.now()}` for cache busting on snapshots.
  </action>
  <verify>
```bash
# Check TypeScript compiles
cd /root/jarvis-ui && npx tsc --noEmit 2>&1 | head -20
```
  </verify>
  <done>
camera.ts exports useCameraStore with state and actions. useCameraPolling.ts exports hook that fetches camera list and polls snapshots every 10s with proper blob URL cleanup on unmount.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CameraPanel, CameraCard, and CameraModal components</name>
  <files>
    jarvis-ui/src/components/camera/CameraPanel.tsx
    jarvis-ui/src/components/camera/CameraCard.tsx
    jarvis-ui/src/components/camera/CameraModal.tsx
    jarvis-ui/src/components/center/CenterDisplay.tsx
  </files>
  <action>
Create `jarvis-ui/src/components/camera/CameraCard.tsx`:

```typescript
interface CameraCardProps {
  camera: string;
  snapshotUrl: string | undefined;
  onClick: () => void;
}

export const CameraCard = memo(function CameraCard({ camera, snapshotUrl, onClick }: CameraCardProps) {
  // Format camera name: front_door -> Front Door
  const displayName = camera.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

  return (
    <button
      onClick={onClick}
      className="relative aspect-video bg-jarvis-bg-hover rounded border border-jarvis-amber/20 overflow-hidden hover:border-jarvis-amber/40 transition-colors group"
    >
      {snapshotUrl ? (
        <img
          src={snapshotUrl}
          alt={`${displayName} camera`}
          className="w-full h-full object-cover"
          loading="lazy"
        />
      ) : (
        <div className="absolute inset-0 flex items-center justify-center text-jarvis-text-dim">
          Loading...
        </div>
      )}
      {/* Camera name overlay */}
      <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent px-2 py-1">
        <span className="text-[10px] font-display text-jarvis-amber uppercase tracking-wider">
          {displayName}
        </span>
      </div>
      {/* Hover indicator */}
      <div className="absolute inset-0 bg-jarvis-amber/5 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
        <span className="text-jarvis-amber text-xs font-display">ENLARGE</span>
      </div>
    </button>
  );
});
```

Create `jarvis-ui/src/components/camera/CameraModal.tsx`:

Follow ConfirmDialog.tsx pattern for modal structure:
- Fixed overlay with `bg-black/80 backdrop-blur-sm`
- Escape key to close (useEffect with keydown listener)
- Click backdrop to close
- X button in top-right corner
- Display full-size snapshot with aspect-ratio preserved
- Show camera name in header

```typescript
interface CameraModalProps {
  camera: string;
  snapshotUrl: string;
  onClose: () => void;
}

export function CameraModal({ camera, snapshotUrl, onClose }: CameraModalProps) {
  // Escape key handler
  useEffect(() => {
    const handler = (e: KeyboardEvent) => { if (e.key === 'Escape') onClose(); };
    document.addEventListener('keydown', handler);
    return () => document.removeEventListener('keydown', handler);
  }, [onClose]);

  const displayName = camera.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"
      onClick={onClose}
    >
      <div
        className="relative max-w-4xl max-h-[90vh] m-4"
        onClick={e => e.stopPropagation()}
      >
        {/* Header */}
        <div className="flex items-center justify-between mb-2">
          <span className="font-display text-jarvis-amber text-sm uppercase tracking-wider">
            {displayName}
          </span>
          <button
            onClick={onClose}
            className="text-jarvis-text-dim hover:text-jarvis-amber transition-colors"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
              <path d="M18 6L6 18M6 6l12 12" />
            </svg>
          </button>
        </div>
        {/* Image */}
        <img
          src={snapshotUrl}
          alt={`${displayName} camera full view`}
          className="max-w-full max-h-[80vh] rounded border border-jarvis-amber/30"
        />
      </div>
    </div>
  );
}
```

Create `jarvis-ui/src/components/camera/CameraPanel.tsx`:

```typescript
export function CameraPanel() {
  const cameras = useCameraStore(s => s.cameras);
  const snapshots = useCameraStore(s => s.snapshots);
  const selectedCamera = useCameraStore(s => s.selectedCamera);
  const modalOpen = useCameraStore(s => s.modalOpen);
  const openModal = useCameraStore(s => s.openModal);
  const closeModal = useCameraStore(s => s.closeModal);

  useCameraPolling(10000); // 10s refresh

  return (
    <div className="p-3">
      {/* Camera grid - 2 columns on md+, 1 on mobile */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        {cameras.map(camera => (
          <CameraCard
            key={camera}
            camera={camera}
            snapshotUrl={snapshots[camera]}
            onClick={() => openModal(camera)}
          />
        ))}
      </div>

      {/* Empty state */}
      {cameras.length === 0 && (
        <div className="text-center text-jarvis-text-dim py-8">
          <p className="text-sm">No cameras available</p>
        </div>
      )}

      {/* Modal */}
      {modalOpen && selectedCamera && snapshots[selectedCamera] && (
        <CameraModal
          camera={selectedCamera}
          snapshotUrl={snapshots[selectedCamera]}
          onClose={closeModal}
        />
      )}
    </div>
  );
}
```

Update `jarvis-ui/src/components/center/CenterDisplay.tsx`:

1. Add 'cam' to CenterView type: `type CenterView = 'hud' | 'feed' | 'chat' | 'cam';`
2. Import CameraPanel: `import { CameraPanel } from '../camera/CameraPanel';`
3. Add 'CAM' to the tab buttons array (after 'chat')
4. Add case for 'cam' view that renders `<CameraPanel />`
5. Update header text to show 'CAMERAS' when view === 'cam'
  </action>
  <verify>
```bash
# Build frontend
cd /root/jarvis-ui && npm run build 2>&1 | tail -10

# Verify components exist
ls -la /root/jarvis-ui/src/components/camera/
```
  </verify>
  <done>
CameraPanel displays 2-column grid of cameras with snapshots. CameraCard shows camera name overlay and hover state. CameraModal opens on click with full-size image. CenterDisplay has CAM tab that renders CameraPanel.
  </done>
</task>

</tasks>

<verification>
1. Backend compiles: `cd /root/jarvis-backend && npm run build`
2. Frontend compiles: `cd /root/jarvis-ui && npm run build`
3. Docker stack running: `docker compose ps` shows all services healthy
4. Camera API works: `curl http://localhost:4000/api/cameras` returns camera names
5. Snapshots proxy works: `curl -o /tmp/test.jpg http://localhost:4000/api/cameras/front_door/snapshot && file /tmp/test.jpg` shows JPEG
6. UI loads: Open http://192.168.1.50:3004, click CAM tab, see camera grid
7. Modal works: Click camera snapshot, modal opens with full-size image, Escape closes it
</verification>

<success_criteria>
1. Dashboard shows CAM tab alongside HUD, FEED, CHAT tabs
2. CAM view displays 2-camera snapshot grid (front_door, side_house)
3. Snapshots auto-refresh every 10 seconds (visible change when camera view changes)
4. Clicking a camera opens modal with full-size snapshot
5. Modal closes via X button, backdrop click, or Escape key
6. No console errors related to camera functionality
7. No memory leaks from blob URLs (revokeSnapshots called on unmount)
</success_criteria>

<output>
After completion, create `.planning/phases/28-camera-dashboard/28-01-SUMMARY.md`
</output>
