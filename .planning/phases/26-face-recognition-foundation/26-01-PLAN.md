---
phase: 26-face-recognition-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - jarvis-backend/src/clients/frigate.ts
autonomous: true

must_haves:
  truths:
    - "Frigate face recognition is enabled with model_size: small"
    - "frigate.ts client can parse sub_label as [name, confidence] array"
    - "getEvents returns face recognition data in events"
  artifacts:
    - path: "jarvis-backend/src/clients/frigate.ts"
      provides: "Extended Frigate client with face recognition support"
      exports: ["FrigateEvent", "getEvents", "getFaceLibrary", "parseFaceSubLabel"]
  key_links:
    - from: "frigate.ts getEvents"
      to: "Frigate API /api/events"
      via: "HTTP GET with sub_label parsing"
      pattern: "sub_label.*\\[.*\\]"
---

<objective>
Enable Frigate face recognition and extend the frigate.ts client to parse face data from events.

Purpose: Frigate 0.16.4 has face recognition available but disabled. This plan enables it and updates the client to properly parse the sub_label field which contains face recognition results as [name, confidence] arrays.

Output: Extended frigate.ts client with face recognition support and verified Frigate configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/milestones/v1.6-ROADMAP.md
@.planning/research/ARCHITECTURE.md
@jarvis-backend/src/clients/frigate.ts
@jarvis-backend/src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable Frigate face recognition via config</name>
  <files>SSH to agent1 (192.168.1.61) to modify Frigate config</files>
  <action>
    SSH to agent1 and enable face recognition in Frigate config:

    1. Locate Frigate config file (typically /opt/frigate/config/config.yml or similar)
    2. Add or update face_recognition section:
       ```yaml
       face_recognition:
         enabled: true
         model_size: small  # CPU-friendly FaceNet
         threshold: 0.7     # Recognition confidence threshold
         min_area: 1500     # Minimum face area in pixels
       ```
    3. Restart Frigate container to apply config
    4. Verify face recognition is enabled via API: `curl http://192.168.1.61:5000/api/config | jq '.face_recognition'`

    Note: model_size: small is required for CPU inference (no GPU on agent1).
  </action>
  <verify>
    curl -s http://192.168.1.61:5000/api/config | jq '.face_recognition.enabled' returns true
  </verify>
  <done>Frigate face recognition enabled with model_size: small, verified via API</done>
</task>

<task type="auto">
  <name>Task 2: Extend frigate.ts client for face recognition</name>
  <files>jarvis-backend/src/clients/frigate.ts</files>
  <action>
    Update frigate.ts with the following changes:

    1. Update FrigateEvent interface - sub_label can be string, null, or [name, confidence] array:
       ```typescript
       export interface FrigateEvent {
         // ... existing fields
         sub_label: string | [string, number] | null;  // Face recognition: [name, confidence]
         // ... rest
       }
       ```

    2. Add helper function to parse sub_label safely:
       ```typescript
       /**
        * Parse face recognition sub_label into structured format.
        * Frigate returns sub_label as:
        *   - null (no face detected)
        *   - string (legacy format, just name)
        *   - [name, confidence] array (face recognition with confidence)
        */
       export function parseFaceSubLabel(subLabel: string | [string, number] | null): {
         name: string | null;
         confidence: number | null;
       } {
         if (subLabel === null) {
           return { name: null, confidence: null };
         }
         if (typeof subLabel === 'string') {
           return { name: subLabel, confidence: null };
         }
         if (Array.isArray(subLabel) && subLabel.length >= 2) {
           return { name: subLabel[0], confidence: subLabel[1] };
         }
         return { name: null, confidence: null };
       }
       ```

    3. Add function to get face library from Frigate:
       ```typescript
       /**
        * Get list of known faces from Frigate face library.
        * Returns names of all enrolled faces.
        */
       export async function getFaceLibrary(): Promise<string[]> {
         const config = await getConfig();
         // Face library is at /media/frigate/clips/faces/{person_name}/
         // API endpoint: GET /api/face_recognition/labels
         try {
           return await frigateGet<string[]>('/face_recognition/labels');
         } catch {
           // Fallback: return empty if face recognition not enabled
           return [];
         }
       }
       ```

    4. Add getEvents option to filter by sub_label presence:
       - Add `has_face?: boolean` option to getEvents
       - When has_face is true, filter client-side for events where sub_label is not null

    5. Add convenience method for recent face events:
       ```typescript
       /**
        * Get recent events with recognized faces.
        * Returns only person events that have face recognition data.
        */
       export async function getRecentFaceEvents(options?: {
         camera?: string;
         limit?: number;
         after?: number;
       }): Promise<Array<FrigateEvent & { face: { name: string; confidence: number } }>> {
         const events = await getEvents({
           label: 'person',
           limit: options?.limit ?? 20,
           camera: options?.camera,
           after: options?.after,
           has_snapshot: true,
         });

         return events
           .filter(e => e.sub_label !== null)
           .map(e => {
             const parsed = parseFaceSubLabel(e.sub_label);
             return {
               ...e,
               face: {
                 name: parsed.name ?? 'unknown',
                 confidence: parsed.confidence ?? 0,
               },
             };
           });
       }
       ```

    Do NOT modify any other behavior - preserve all existing exports and functionality.
  </action>
  <verify>
    npm run build (in jarvis-backend) - no TypeScript errors
    npm test (if frigate client tests exist) - all pass
  </verify>
  <done>
    frigate.ts exports parseFaceSubLabel, getFaceLibrary, and getRecentFaceEvents functions.
    FrigateEvent.sub_label typed to handle [name, confidence] arrays.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify face recognition integration</name>
  <files>None (verification only)</files>
  <action>
    Create a quick verification script to test face recognition:

    1. Check Frigate face recognition is responding:
       ```bash
       curl -s http://192.168.1.61:5000/api/config | jq '.face_recognition'
       ```

    2. Check for existing faces in library:
       ```bash
       curl -s http://192.168.1.61:5000/api/face_recognition/labels
       ```

    3. Query recent person events to see sub_label format:
       ```bash
       curl -s "http://192.168.1.61:5000/api/events?label=person&limit=5" | jq '.[].sub_label'
       ```

    4. Rebuild and verify backend starts:
       ```bash
       cd /root/jarvis-backend && npm run build
       ```

    Document the current state:
    - Is face recognition enabled? (should be true after Task 1)
    - Are there any enrolled faces? (may be empty initially)
    - What format is sub_label returning? (should be null or [name, confidence])
  </action>
  <verify>
    Frigate face recognition config shows enabled: true
    Backend builds without errors
    Documented current face library state
  </verify>
  <done>
    Face recognition verified working. State documented (enrolled faces count, sub_label format).
  </done>
</task>

</tasks>

<verification>
1. Frigate API shows face_recognition.enabled: true
2. jarvis-backend builds without TypeScript errors
3. parseFaceSubLabel correctly handles null, string, and [name, confidence] formats
4. getRecentFaceEvents returns properly typed results
</verification>

<success_criteria>
- Frigate face recognition enabled with model_size: small (CPU inference)
- frigate.ts exports new functions: parseFaceSubLabel, getFaceLibrary, getRecentFaceEvents
- FrigateEvent interface updated to handle sub_label as array or string
- Backend compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/26-face-recognition-foundation/26-01-SUMMARY.md`
</output>
