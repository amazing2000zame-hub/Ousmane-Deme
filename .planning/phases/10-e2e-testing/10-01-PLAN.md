# Plan 10-01: Test Infrastructure + Unit Tests

## Goal
Set up vitest test runner and write unit tests for router, memory, cost tracker, and safety framework.

## Requirements Addressed
TEST-01 (npm test runs without live cluster), TEST-02 (safety tier tests), TEST-03 (router tests), TEST-04 (memory TTL tests)

## Files to Create

### 1. `jarvis-backend/vitest.config.ts`
Vitest configuration with TypeScript support, test patterns, coverage.

### 2. `jarvis-backend/src/__tests__/router.test.ts`
Router unit tests:
- Conversational messages → Qwen
- Cluster action keywords → Claude
- Override passkey → Claude
- Entity references (node names, VMIDs) → Claude
- Budget exceeded → Qwen fallback
- Follow-up routing
- Default routing

### 3. `jarvis-backend/src/__tests__/memory.test.ts`
Memory system unit tests:
- Save/retrieve memories across tiers
- TTL expiration (conversation 7d, episodic 30d, semantic permanent)
- Upsert idempotency
- Search by keyword
- Cleanup service deletes expired
- Stats reporting

### 4. `jarvis-backend/src/__tests__/cost-tracker.test.ts`
Cost tracker unit tests:
- Claude cost calculation
- Qwen cost (free)
- Budget check with mocked DB

### 5. `jarvis-backend/src/__tests__/safety.test.ts`
Safety framework unit tests:
- GREEN tier auto-executes
- YELLOW tier auto-executes with logging
- RED tier requires confirmation
- BLACK tier always blocked
- Protected resources (VMID 103)

### 6. `jarvis-backend/src/__tests__/memory-extractor.test.ts`
Memory extractor unit tests:
- Session summary extraction
- Preference detection patterns
- Event extraction (severity filtering)

### 7. `jarvis-backend/src/__tests__/memory-recall.test.ts`
Recall detection unit tests:
- Recall pattern matching
- Search term extraction
- Non-recall messages rejected

## Files to Modify

### 8. `jarvis-backend/package.json`
- Add `vitest` dev dependency
- Add `test` script: `vitest run`
- Add `test:watch` script: `vitest`
- Add `test:coverage` script: `vitest run --coverage`

## Verification
- [ ] `npm test` runs and passes all tests
- [ ] No live cluster or API keys needed
- [ ] All 4 safety tiers tested
- [ ] Router covers all 7 routing stages
- [ ] Memory TTL behavior verified
