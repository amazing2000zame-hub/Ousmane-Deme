---
phase: 29-proactive-alerts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - jarvis-backend/src/services/alert-monitor.ts
  - jarvis-backend/src/config.ts
  - jarvis-backend/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Unknown person events at entry cameras trigger alert:notification Socket.IO event within 10 seconds"
    - "5-minute cooldown prevents repeated alerts for same camera"
    - "Alert includes event ID, camera name, timestamp, and thumbnail URL"
  artifacts:
    - path: "jarvis-backend/src/services/alert-monitor.ts"
      provides: "Polling service with cooldown deduplication"
      exports: ["AlertMonitor", "startAlertMonitor", "stopAlertMonitor"]
    - path: "jarvis-backend/src/config.ts"
      provides: "Alert configuration options"
      contains: "alertPollIntervalMs"
  key_links:
    - from: "jarvis-backend/src/index.ts"
      to: "jarvis-backend/src/services/alert-monitor.ts"
      via: "import and startAlertMonitor() call"
      pattern: "startAlertMonitor\\(eventsNs"
    - from: "jarvis-backend/src/services/alert-monitor.ts"
      to: "jarvis-backend/src/clients/frigate.ts"
      via: "getEvents() call with after parameter"
      pattern: "getEvents\\("
---

<objective>
Create backend alert monitoring service that polls Frigate for unknown person events and emits proactive notifications via Socket.IO.

Purpose: Enable real-time security alerts when unrecognized individuals are detected at entry cameras, fulfilling ALERT-01, ALERT-02, and ALERT-04 requirements.

Output:
- alert-monitor.ts service with 5-second polling and cooldown tracking
- Config options for poll interval, cooldown duration, entry cameras, TTS toggle
- Integration with index.ts for startup/shutdown lifecycle
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-proactive-alerts/29-RESEARCH.md
@jarvis-backend/src/clients/frigate.ts
@jarvis-backend/src/config.ts
@jarvis-backend/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add alert configuration options</name>
  <files>jarvis-backend/src/config.ts</files>
  <action>
Add the following configuration options to config.ts (place after the Frigate section):

```typescript
// Phase 29: Proactive Alerts
alertPollIntervalMs: parseInt(process.env.ALERT_POLL_INTERVAL_MS || '5000', 10),
alertCooldownMs: parseInt(process.env.ALERT_COOLDOWN_MS || '300000', 10), // 5 minutes
alertEntryCameras: (process.env.ALERT_ENTRY_CAMERAS || 'front_door').split(',').filter(Boolean),
alertTtsEnabled: process.env.ALERT_TTS_ENABLED !== 'false', // default true
```

These provide:
- 5-second poll interval (ALERT-01)
- 5-minute cooldown (ALERT-04)
- Configurable entry cameras (default: front_door)
- TTS toggle (ALERT-05)
  </action>
  <verify>TypeScript compiles: `cd /root/jarvis-backend && npx tsc --noEmit`</verify>
  <done>Config exports alertPollIntervalMs, alertCooldownMs, alertEntryCameras, alertTtsEnabled</done>
</task>

<task type="auto">
  <name>Task 2: Create AlertMonitor service</name>
  <files>jarvis-backend/src/services/alert-monitor.ts</files>
  <action>
Create the alert monitoring service at jarvis-backend/src/services/alert-monitor.ts.

Key implementation details:
1. Use `Map<string, number>` for O(1) cooldown lookups with key `${camera}:person`
2. Use `isPolling` lock flag to prevent poll stacking (Pitfall 1 from research)
3. Use `Math.floor(Date.now() / 1000)` for Frigate timestamp comparison (Pitfall 4)
4. Filter events with `has_snapshot: true` (Pitfall 3)
5. Only process events where `sub_label === null` (unknown person)
6. Only process events from configured entry cameras
7. Clean up expired cooldowns after each poll to prevent memory leak

Socket.IO event structure (emitted on eventsNs):
```typescript
eventsNs.emit('alert:notification', {
  id: event.id,
  type: 'unknown_person',
  camera: event.camera,
  timestamp: event.start_time,
  thumbnailUrl: `/api/events/${event.id}/thumbnail`,
  snapshotUrl: `/api/events/${event.id}/snapshot`,
  message: `Unknown person detected at ${event.camera.replace(/_/g, ' ')}`,
});
```

Export three functions:
- `startAlertMonitor(eventsNs: Namespace): void` - Start polling
- `stopAlertMonitor(): void` - Stop polling (for graceful shutdown)
- `AlertMonitor` class (optional, for testing)

Log format:
- `[Alert Monitor] Started polling every ${interval}ms`
- `[Alert Monitor] Unknown person at ${camera} (event ${id})`
- `[Alert Monitor] Poll failed: ${error.message}`

IMPORTANT: Import getEvents from '../clients/frigate.js' (note .js extension for ESM).
  </action>
  <verify>
TypeScript compiles: `cd /root/jarvis-backend && npx tsc --noEmit`
File exists: `ls -la /root/jarvis-backend/src/services/alert-monitor.ts`
  </verify>
  <done>
AlertMonitor polls Frigate every 5 seconds, detects unknown persons at entry cameras, applies 5-minute cooldown, and emits alert:notification events
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire AlertMonitor into application lifecycle</name>
  <files>jarvis-backend/src/index.ts</files>
  <action>
Update index.ts to integrate the AlertMonitor service:

1. Add import at top:
```typescript
import { startAlertMonitor, stopAlertMonitor } from './services/alert-monitor.js';
```

2. Start the monitor after setupChatHandlers (after line 79):
```typescript
// Start proactive alert monitoring (Phase 29: ALERT-01)
startAlertMonitor(eventsNs);
console.log('[Alert Monitor] Proactive alert service initialized');
```

3. Stop the monitor in the shutdown function (add before stopMonitor):
```typescript
stopAlertMonitor();
```

This ensures:
- Alert monitor starts after Socket.IO namespaces are ready
- Alert monitor stops gracefully on SIGTERM/SIGINT
  </action>
  <verify>
TypeScript compiles: `cd /root/jarvis-backend && npx tsc --noEmit`
Grep for startAlertMonitor: `grep -n "startAlertMonitor" /root/jarvis-backend/src/index.ts`
  </verify>
  <done>
AlertMonitor integrated into application startup and shutdown lifecycle
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation succeeds: `cd /root/jarvis-backend && npx tsc --noEmit`
2. Backend starts without errors: `cd /root && docker compose up -d --build jarvis-backend && docker compose logs -f jarvis-backend`
3. Verify alert monitor startup log: Should see "[Alert Monitor] Started polling every 5000ms" and "[Alert Monitor] Proactive alert service initialized"
4. If Frigate has recent person events without sub_label at front_door, should see alert:notification emissions in logs
</verification>

<success_criteria>
- AlertMonitor service polls Frigate every 5 seconds (ALERT-01)
- Unknown person events (sub_label === null) at entry cameras emit alert:notification (ALERT-02)
- 5-minute cooldown prevents repeated alerts for same camera (ALERT-04)
- Service starts on backend startup and stops on shutdown
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/29-proactive-alerts/29-01-SUMMARY.md`
</output>
