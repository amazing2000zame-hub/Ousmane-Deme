---
phase: 22-tts-reliability-piper-fallback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /root/docker-compose.yml
  - /root/.env
  - /root/jarvis-backend/src/config.ts
autonomous: true

must_haves:
  truths:
    - "Piper TTS container starts and downloads en_US-hfc_male-medium voice model automatically"
    - "Backend config exposes piperTtsEndpoint pointing to jarvis-piper:5000"
    - "Piper container is on jarvis-net and reachable from jarvis-backend by DNS name"
  artifacts:
    - path: "/root/docker-compose.yml"
      provides: "jarvis-piper service definition with resource limits, healthcheck, piper-voices volume"
      contains: "jarvis-piper"
    - path: "/root/.env"
      provides: "PIPER_TTS_ENDPOINT environment variable"
      contains: "PIPER_TTS_ENDPOINT"
    - path: "/root/jarvis-backend/src/config.ts"
      provides: "piperTtsEndpoint config field"
      contains: "piperTtsEndpoint"
  key_links:
    - from: "/root/docker-compose.yml"
      to: "jarvis-piper container"
      via: "rhasspy/wyoming-piper Docker image with --voice flag"
      pattern: "rhasspy/wyoming-piper"
    - from: "/root/docker-compose.yml"
      to: "/root/.env"
      via: "PIPER_TTS_ENDPOINT env var interpolation"
      pattern: "PIPER_TTS_ENDPOINT"
    - from: "/root/jarvis-backend/src/config.ts"
      to: "process.env.PIPER_TTS_ENDPOINT"
      via: "environment variable read"
      pattern: "piperTtsEndpoint.*PIPER_TTS_ENDPOINT"
---

<objective>
Deploy Piper TTS as a Docker container alongside the existing XTTS service and wire the endpoint configuration into the backend.

Purpose: TTS-01 requires a fast CPU-based Piper TTS fallback engine running as a Docker container with <200ms synthesis. This plan sets up the infrastructure so Plan 02 can implement the fallback routing logic.
Output: Running jarvis-piper container on jarvis-net, piperTtsEndpoint in backend config, PIPER_TTS_ENDPOINT in .env.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-tts-reliability-piper-fallback/22-RESEARCH.md

Source files to modify:
@/root/docker-compose.yml
@/root/.env
@/root/jarvis-backend/src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Piper TTS Docker service and volume</name>
  <files>/root/docker-compose.yml</files>
  <action>
Add a `jarvis-piper` service to docker-compose.yml using the `rhasspy/wyoming-piper:latest` image. Place it AFTER the `jarvis-tts` service block and BEFORE the `volumes:` section.

Service configuration:
```yaml
jarvis-piper:
  image: rhasspy/wyoming-piper:latest
  container_name: jarvis-piper
  restart: unless-stopped
  ports:
    - "5000:5000"
  volumes:
    - piper-voices:/data
  command: --voice en_US-hfc_male-medium
  networks:
    - jarvis-net
  deploy:
    resources:
      limits:
        cpus: "4"
        memory: 512M
      reservations:
        cpus: "1"
        memory: 256M
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:5000/?text=test"]
    interval: 30s
    timeout: 5s
    retries: 3
    start_period: 30s
  logging:
    driver: json-file
    options:
      max-size: "5m"
      max-file: "3"
```

Add `piper-voices` to the `volumes:` section at the bottom:
```yaml
volumes:
  jarvis-data:
    driver: local
  piper-voices:
    driver: local
```

Also add the `PIPER_TTS_ENDPOINT` environment variable to the `jarvis-backend` service's `environment` list:
```yaml
- PIPER_TTS_ENDPOINT=${PIPER_TTS_ENDPOINT:-http://jarvis-piper:5000}
```

IMPORTANT: Do NOT add `depends_on: jarvis-piper` to jarvis-backend. Piper is a fallback, not a requirement. The backend must start even if Piper is not yet ready.

IMPORTANT: Do NOT modify any existing service definitions (jarvis-backend, jarvis-frontend, jarvis-tts) except adding the one env var to jarvis-backend.
  </action>
  <verify>Run `docker compose config --quiet` from /root to validate the compose file has no syntax errors.</verify>
  <done>docker-compose.yml contains jarvis-piper service with rhasspy/wyoming-piper image, piper-voices volume, healthcheck, resource limits, and PIPER_TTS_ENDPOINT env var on jarvis-backend.</done>
</task>

<task type="auto">
  <name>Task 2: Add Piper endpoint to .env and config.ts</name>
  <files>/root/.env, /root/jarvis-backend/src/config.ts</files>
  <action>
1. Append to `/root/.env`:
```
PIPER_TTS_ENDPOINT=http://jarvis-piper:5000
```

2. In `/root/jarvis-backend/src/config.ts`, add the `piperTtsEndpoint` field to the config object. Place it right after the existing `localTtsEndpoint` line (line 64):
```typescript
// TTS -- Piper CPU fallback (fast, <200ms)
piperTtsEndpoint: process.env.PIPER_TTS_ENDPOINT || 'http://jarvis-piper:5000',
```

Do NOT modify any other config fields. The new field follows the exact same pattern as `localTtsEndpoint` (env var with fallback default).
  </action>
  <verify>Run `cd /root/jarvis-backend && npx tsc --noEmit` to verify TypeScript compilation succeeds with no errors.</verify>
  <done>.env contains PIPER_TTS_ENDPOINT, config.ts exports piperTtsEndpoint accessible as config.piperTtsEndpoint.</done>
</task>

</tasks>

<verification>
1. `docker compose config --quiet` passes (no syntax errors in docker-compose.yml)
2. `npx tsc --noEmit` passes (config.ts compiles)
3. `grep -q 'jarvis-piper' /root/docker-compose.yml` succeeds
4. `grep -q 'piper-voices' /root/docker-compose.yml` succeeds
5. `grep -q 'PIPER_TTS_ENDPOINT' /root/.env` succeeds
6. `grep -q 'piperTtsEndpoint' /root/jarvis-backend/src/config.ts` succeeds
</verification>

<success_criteria>
- jarvis-piper service defined in docker-compose.yml with correct image, voice, healthcheck, resource limits, and network
- piper-voices volume declared for persistent model storage
- PIPER_TTS_ENDPOINT env var passed through to jarvis-backend container
- .env contains PIPER_TTS_ENDPOINT default value
- config.ts exposes piperTtsEndpoint with env var override
- TypeScript compiles without errors
- Docker Compose config validates without errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-tts-reliability-piper-fallback/22-01-SUMMARY.md`
</output>
