---
phase: 31-web-ui-redesign
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - jarvis-ui/src/components/center/InlineCameraCard.tsx
  - jarvis-ui/src/components/center/ToolStatusCard.tsx
autonomous: false

must_haves:
  truths:
    - "Inline camera shows clear connection feedback (connecting vs connected vs error)"
    - "Loading overlay disappears within 10 seconds or shows timeout error"
    - "Tool outputs render within chat bubble without horizontal overflow"
  artifacts:
    - path: "jarvis-ui/src/components/center/InlineCameraCard.tsx"
      provides: "Connection timeout handling"
      contains: "connectionTimeout"
    - path: "jarvis-ui/src/components/center/ToolStatusCard.tsx"
      provides: "Overflow-safe tool result display"
      contains: "overflow-hidden"
  key_links:
    - from: "InlineCameraCard.tsx"
      to: "video-rtc.js readyState"
      via: "polling with timeout"
      pattern: "setInterval.*readyState"
---

<objective>
Add connection timeout to InlineCameraCard, ensure tool outputs render cleanly without breaking layout, and verify responsive behavior.

Purpose: The loading overlay polls every 500ms for video connection but has no timeout, potentially showing "CONNECTING" forever if the stream fails. Additionally, tool outputs can overflow the chat bubble on narrow viewports. This plan fixes both issues and verifies responsive layout.

Output: Robust camera connection feedback with 10-second timeout, overflow-safe tool result display, and verified responsive layout
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-web-ui-redesign/31-RESEARCH.md
@jarvis-ui/src/components/center/InlineCameraCard.tsx
@jarvis-ui/src/components/center/ToolStatusCard.tsx
@jarvis-ui/src/components/layout/Dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add connection timeout to InlineCameraCard</name>
  <files>jarvis-ui/src/components/center/InlineCameraCard.tsx</files>
  <action>
    Update InlineCameraCard.tsx to add:
    1. A 10-second timeout for stream connection
    2. An error state when timeout expires
    3. Clear user feedback for connection status

    Replace the current state and useEffect logic (lines 18-46) with:

    ```tsx
    const videoRef = useRef<VideoRTCElement | null>(null);
    const [connectionState, setConnectionState] = useState<'connecting' | 'connected' | 'error'>('connecting');

    // Set stream source when component mounts
    useEffect(() => {
      const el = videoRef.current as VideoRTCElement | null;
      if (!el) return;

      let mounted = true;

      // video-rtc.js expects property assignment (not setAttribute) to trigger connection
      el.mode = 'mse,webrtc,hls';
      el.media = 'video,audio';
      el.src = `${FRIGATE_URL}/live/mse/api/ws?src=${camera}`;

      // Poll for connection state with timeout
      const startTime = Date.now();
      const CONNECTION_TIMEOUT_MS = 10000; // 10 seconds

      const checkConnection = () => {
        if (!mounted) return;

        const video = el.querySelector('video');
        if (video && !video.paused && video.readyState >= 2) {
          setConnectionState('connected');
          return;
        }

        // Check for timeout
        if (Date.now() - startTime > CONNECTION_TIMEOUT_MS) {
          setConnectionState('error');
          return;
        }
      };

      const intervalId = setInterval(checkConnection, 500);

      return () => {
        mounted = false;
        clearInterval(intervalId);
        // Setting empty src triggers disconnect
        el.src = '';
      };
    }, [camera]);
    ```

    Then update the loading overlay JSX (lines 92-102) to handle all three states:

    ```tsx
    {/* Connection status overlay */}
    {connectionState === 'connecting' && (
      <div className="absolute inset-0 flex items-center justify-center bg-black/50">
        <div className="flex flex-col items-center gap-1">
          <div className="w-1.5 h-1.5 bg-jarvis-amber rounded-full animate-ping" />
          <span className="text-jarvis-text-dim text-[9px] font-display tracking-wider">
            CONNECTING
          </span>
        </div>
      </div>
    )}
    {connectionState === 'error' && (
      <div className="absolute inset-0 flex items-center justify-center bg-black/70">
        <div className="flex flex-col items-center gap-1">
          <svg className="w-4 h-4 text-jarvis-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <span className="text-jarvis-red text-[9px] font-display tracking-wider">
            CONNECTION FAILED
          </span>
          <button
            onClick={() => {
              setConnectionState('connecting');
              // Re-trigger connection by toggling src
              const el = videoRef.current as VideoRTCElement | null;
              if (el) {
                el.src = '';
                setTimeout(() => {
                  el.src = `${FRIGATE_URL}/live/mse/api/ws?src=${camera}`;
                }, 100);
              }
            }}
            className="mt-1 px-2 py-0.5 text-[8px] font-display tracking-wider text-jarvis-amber border border-jarvis-amber/30 rounded hover:bg-jarvis-amber/10 transition-colors"
          >
            RETRY
          </button>
        </div>
      </div>
    )}
    ```

    Remove the old `isConnected` state variable and replace with `connectionState`.
  </action>
  <verify>
    1. Build passes: `cd /root/jarvis-ui && npm run build`
    2. TypeScript has no errors
    3. New state variable exists: `grep -n "connectionState" /root/jarvis-ui/src/components/center/InlineCameraCard.tsx`
  </verify>
  <done>InlineCameraCard shows "CONNECTING" for up to 10 seconds, then "CONNECTION FAILED" with retry button if stream doesn't connect</done>
</task>

<task type="auto">
  <name>Task 2: Harden ToolStatusCard overflow handling</name>
  <files>jarvis-ui/src/components/center/ToolStatusCard.tsx</files>
  <action>
    Update ToolStatusCard.tsx to ensure tool outputs never break the chat bubble layout:

    1. Add `overflow-hidden` to the root container to prevent any child from breaking layout
    2. Constrain the expanded `<pre>` block with `max-w-full` and `overflow-x-auto`
    3. Add `min-w-0` to flex items to prevent flex overflow

    Update the root div (line 39):
    ```tsx
    <div className="my-1 bg-jarvis-bg-card/30 border border-jarvis-amber/5 rounded px-2 py-1 overflow-hidden">
    ```

    Update the flex container (line 40):
    ```tsx
    <div className="flex items-center gap-1.5 min-w-0">
    ```

    Update the expanded pre block (lines 60-63):
    ```tsx
    {hasPreview && expanded && (
      <pre className="text-[10px] font-mono text-jarvis-text-muted mt-1 whitespace-pre-wrap break-all max-w-full max-h-40 overflow-y-auto overflow-x-auto">
        {result}
      </pre>
    )}
    ```

    Note: Changed `break-words` to `break-all` for more aggressive breaking of long unspaced strings (like URLs or JSON keys).
  </action>
  <verify>
    1. Build passes: `cd /root/jarvis-ui && npm run build`
    2. Changes applied: `grep -n "overflow-hidden" /root/jarvis-ui/src/components/center/ToolStatusCard.tsx`
    3. Pre block has overflow handling: `grep "overflow-x-auto" /root/jarvis-ui/src/components/center/ToolStatusCard.tsx`
  </verify>
  <done>ToolStatusCard renders tool outputs within chat bubble without horizontal overflow, even with long unspaced content</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify responsive layout at breakpoints</name>
  <what-built>
    - Connection timeout for InlineCameraCard (10 seconds, error state, retry button)
    - Overflow-safe tool output rendering in ToolStatusCard
  </what-built>
  <how-to-verify>
    1. Rebuild and deploy:
       ```bash
       cd /root && docker compose up -d --build
       ```

    2. Open http://192.168.1.50:3004 in Chrome

    3. Test connection timeout:
       - Stop Frigate: `ssh root@192.168.1.61 "docker stop frigate"`
       - Ask Jarvis "show front door camera"
       - Verify: "CONNECTING" appears, after 10s shows "CONNECTION FAILED" with retry button
       - Restart Frigate: `ssh root@192.168.1.61 "docker start frigate"`
       - Click retry, verify stream connects

    4. Test tool output overflow:
       - Ask Jarvis something that triggers a tool with long output (e.g., "list all VMs in the cluster")
       - Expand the tool result
       - Verify: Content stays within chat bubble, no horizontal page scroll

    5. Test responsive layout (Chrome DevTools device mode - Ctrl+Shift+M):
       - 375px width (mobile): Single column, no horizontal overflow
       - 768px width (tablet): Two columns, chat usable
       - 1024px width (laptop): Three columns appear
       - 1280px width (desktop): Full layout with terminal

    6. Test terminal collapse:
       - At 1280px, click terminal collapse button
       - Verify: Smooth animation, no layout glitch
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. **Connection timeout test:**
   - Stop Frigate temporarily: `ssh root@192.168.1.61 "docker stop frigate"`
   - Ask Jarvis to "show front door camera"
   - Verify "CONNECTING" appears
   - After 10 seconds, verify "CONNECTION FAILED" appears with retry button
   - Click retry, verify it attempts reconnection
   - Restart Frigate: `ssh root@192.168.1.61 "docker start frigate"`
   - Verify retry now succeeds and stream shows

2. **Tool output overflow test:**
   - Ask Jarvis a question that triggers a tool with verbose output
   - Expand the tool result preview
   - Verify content doesn't overflow horizontally

3. **Responsive layout verification:**
   - Test at mobile (375px) - single column
   - Test at tablet (768px) - two columns
   - Test at laptop (1024px) - three columns
   - Test at desktop (1280px) - full layout
   - Terminal collapse works at all desktop sizes

4. **Build verification:**
   ```bash
   cd /root/jarvis-ui && npm run build
   # Should complete with no errors
   ```
</verification>

<success_criteria>
- InlineCameraCard has 10-second connection timeout
- Error state shows "CONNECTION FAILED" with retry button
- Retry button resets state and attempts reconnection
- ToolStatusCard has overflow-hidden on container
- Tool outputs don't cause horizontal scroll on any viewport
- Dashboard loads without layout glitches at all tested breakpoints
- No horizontal overflow at any viewport width
- Terminal collapse/expand works smoothly
- Inline camera fits within chat messages at all sizes
</success_criteria>

<output>
After completion, create `.planning/phases/31-web-ui-redesign/31-02-SUMMARY.md`
</output>
