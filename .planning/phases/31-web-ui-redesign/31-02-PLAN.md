---
phase: 31-web-ui-redesign
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - jarvis-ui/src/components/center/InlineCameraCard.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard loads reliably without layout glitches"
    - "Inline camera shows clear connection feedback (connecting vs connected vs error)"
    - "Loading overlay disappears within 10 seconds or shows timeout error"
  artifacts:
    - path: "jarvis-ui/src/components/center/InlineCameraCard.tsx"
      provides: "Connection timeout handling"
      contains: "connectionTimeout"
  key_links:
    - from: "InlineCameraCard.tsx"
      to: "video-rtc.js readyState"
      via: "polling with timeout"
      pattern: "setInterval.*readyState"
---

<objective>
Add connection timeout to InlineCameraCard and audit responsive layout breakpoints.

Purpose: The loading overlay polls every 500ms for video connection but has no timeout, potentially showing "CONNECTING" forever if the stream fails. Additionally, responsive layout needs verification at key breakpoints to ensure no visual glitches.

Output: Robust camera connection feedback with 10-second timeout, and verified responsive layout behavior
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-web-ui-redesign/31-RESEARCH.md
@jarvis-ui/src/components/center/InlineCameraCard.tsx
@jarvis-ui/src/components/layout/Dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add connection timeout to InlineCameraCard</name>
  <files>jarvis-ui/src/components/center/InlineCameraCard.tsx</files>
  <action>
    Update InlineCameraCard.tsx to add:
    1. A 10-second timeout for stream connection
    2. An error state when timeout expires
    3. Clear user feedback for connection status

    Replace the current state and useEffect logic (lines 18-46) with:

    ```tsx
    const videoRef = useRef<VideoRTCElement | null>(null);
    const [connectionState, setConnectionState] = useState<'connecting' | 'connected' | 'error'>('connecting');

    // Set stream source when component mounts
    useEffect(() => {
      const el = videoRef.current as VideoRTCElement | null;
      if (!el) return;

      let mounted = true;

      // video-rtc.js expects property assignment (not setAttribute) to trigger connection
      el.mode = 'mse,webrtc,hls';
      el.media = 'video,audio';
      el.src = `${FRIGATE_URL}/live/mse/api/ws?src=${camera}`;

      // Poll for connection state with timeout
      const startTime = Date.now();
      const CONNECTION_TIMEOUT_MS = 10000; // 10 seconds

      const checkConnection = () => {
        if (!mounted) return;

        const video = el.querySelector('video');
        if (video && !video.paused && video.readyState >= 2) {
          setConnectionState('connected');
          return;
        }

        // Check for timeout
        if (Date.now() - startTime > CONNECTION_TIMEOUT_MS) {
          setConnectionState('error');
          return;
        }
      };

      const intervalId = setInterval(checkConnection, 500);

      return () => {
        mounted = false;
        clearInterval(intervalId);
        // Setting empty src triggers disconnect
        el.src = '';
      };
    }, [camera]);
    ```

    Then update the loading overlay JSX (lines 92-102) to handle all three states:

    ```tsx
    {/* Connection status overlay */}
    {connectionState === 'connecting' && (
      <div className="absolute inset-0 flex items-center justify-center bg-black/50">
        <div className="flex flex-col items-center gap-1">
          <div className="w-1.5 h-1.5 bg-jarvis-amber rounded-full animate-ping" />
          <span className="text-jarvis-text-dim text-[9px] font-display tracking-wider">
            CONNECTING
          </span>
        </div>
      </div>
    )}
    {connectionState === 'error' && (
      <div className="absolute inset-0 flex items-center justify-center bg-black/70">
        <div className="flex flex-col items-center gap-1">
          <svg className="w-4 h-4 text-jarvis-red" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <span className="text-jarvis-red text-[9px] font-display tracking-wider">
            CONNECTION FAILED
          </span>
          <button
            onClick={() => {
              setConnectionState('connecting');
              // Re-trigger connection by toggling src
              const el = videoRef.current as VideoRTCElement | null;
              if (el) {
                el.src = '';
                setTimeout(() => {
                  el.src = `${FRIGATE_URL}/live/mse/api/ws?src=${camera}`;
                }, 100);
              }
            }}
            className="mt-1 px-2 py-0.5 text-[8px] font-display tracking-wider text-jarvis-amber border border-jarvis-amber/30 rounded hover:bg-jarvis-amber/10 transition-colors"
          >
            RETRY
          </button>
        </div>
      </div>
    )}
    ```

    Remove the old `isConnected` state variable and replace with `connectionState`.
  </action>
  <verify>
    1. Build passes: `cd /root/jarvis-ui && npm run build`
    2. TypeScript has no errors
    3. New state variable exists: `grep -n "connectionState" /root/jarvis-ui/src/components/center/InlineCameraCard.tsx`
  </verify>
  <done>InlineCameraCard shows "CONNECTING" for up to 10 seconds, then "CONNECTION FAILED" with retry button if stream doesn't connect</done>
</task>

<task type="auto">
  <name>Task 2: Test responsive layout at breakpoints</name>
  <files>none (testing only)</files>
  <action>
    Perform a responsive layout audit at key Tailwind breakpoints. Document any issues found.

    Test the following widths in browser DevTools (Chrome: Ctrl+Shift+M for device mode):

    1. **Mobile (< 768px):** 375px (iPhone SE), 414px (iPhone 12)
       - Verify: Single column stack, all panels visible
       - Check: No horizontal overflow, chat input accessible

    2. **Tablet/md (768px):** Exactly 768px
       - Verify: 2-column layout (300px left, 1fr center)
       - Check: Smooth transition from 1 column, no layout jump

    3. **Laptop/lg (1024px):** Exactly 1024px
       - Verify: 3-column layout appears (280px left, 1fr center, 320px right)
       - Check: Terminal panel visible, no overlap

    4. **Desktop/xl (1280px):** Exactly 1280px and 1440px
       - Verify: 3-column layout (320px left, 1fr center, 380px right)
       - Check: All panels properly sized

    5. **Terminal collapse test:**
       - At xl (1280px), click terminal collapse button
       - Verify: Right column shrinks to 0, no layout glitch
       - Expand terminal, verify it returns correctly

    6. **Chat with inline camera:**
       - At various widths, trigger "show me the front door camera"
       - Verify: Camera card fits within chat bubble, no overflow

    Document any issues in the verification section. If issues found, create a follow-up task.
  </action>
  <verify>
    Open browser to http://192.168.1.50:3004 and test each breakpoint:

    ```bash
    # Rebuild and deploy
    cd /root && docker compose up -d --build
    ```

    Use Chrome DevTools device toolbar (Ctrl+Shift+I, then Ctrl+Shift+M) to test:
    - 375px width (mobile)
    - 768px width (tablet breakpoint)
    - 1024px width (laptop breakpoint)
    - 1280px width (desktop breakpoint)
    - 1440px width (large desktop)

    At each size, verify:
    - No horizontal scrollbar appears
    - No content overlaps
    - Transitions between breakpoints are smooth
    - Chat panel is usable at all sizes
  </verify>
  <done>Layout verified at all breakpoints with no critical issues, or issues documented for future fix</done>
</task>

</tasks>

<verification>
1. **Connection timeout test:**
   - Stop Frigate temporarily: `ssh root@192.168.1.61 "docker stop frigate"`
   - Ask Jarvis to "show front door camera"
   - Verify "CONNECTING" appears
   - After 10 seconds, verify "CONNECTION FAILED" appears with retry button
   - Click retry, verify it attempts reconnection
   - Restart Frigate: `ssh root@192.168.1.61 "docker start frigate"`
   - Verify retry now succeeds and stream shows

2. **Responsive layout verification:**
   - Test at mobile (375px) - single column
   - Test at tablet (768px) - two columns
   - Test at laptop (1024px) - three columns
   - Test at desktop (1280px) - full layout
   - Terminal collapse works at all desktop sizes

3. **Build verification:**
   ```bash
   cd /root/jarvis-ui && npm run build
   # Should complete with no errors
   ```
</verification>

<success_criteria>
- InlineCameraCard has 10-second connection timeout
- Error state shows "CONNECTION FAILED" with retry button
- Retry button resets state and attempts reconnection
- Dashboard loads without layout glitches at all tested breakpoints
- No horizontal overflow at any viewport width
- Terminal collapse/expand works smoothly
- Inline camera fits within chat messages at all sizes
</success_criteria>

<output>
After completion, create `.planning/phases/31-web-ui-redesign/31-02-SUMMARY.md`
</output>
