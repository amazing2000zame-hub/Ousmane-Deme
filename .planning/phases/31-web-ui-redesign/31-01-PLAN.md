---
phase: 31-web-ui-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - jarvis-ui/src/components/center/ChatMessage.tsx
  - jarvis-backend/src/ai/tools.ts
  - jarvis-backend/src/ai/system-prompt.ts
autonomous: true

must_haves:
  truths:
    - "User can click X button on inline camera to dismiss it"
    - "User can say 'close the camera' and Jarvis dismisses the feed via voice"
    - "Camera dismissal works consistently via both click and voice"
  artifacts:
    - path: "jarvis-ui/src/components/center/ChatMessage.tsx"
      provides: "InlineCameraCard with onClose handler"
      contains: "onClose={() => useChatStore"
    - path: "jarvis-backend/src/ai/tools.ts"
      provides: "close_live_feed Claude tool definition"
      contains: "close_live_feed"
    - path: "jarvis-backend/src/ai/system-prompt.ts"
      provides: "close_live_feed usage guidance"
      contains: "close_live_feed"
  key_links:
    - from: "ChatMessage.tsx"
      to: "useChatStore.clearInlineCamera()"
      via: "onClose prop"
      pattern: "clearInlineCamera"
    - from: "Claude"
      to: "close_live_feed tool"
      via: "tools.ts definition"
      pattern: "close_live_feed.*close.*camera"
---

<objective>
Wire up camera dismissal so users can close inline camera feeds via both click and voice command.

Purpose: Success criteria #5 requires cameras to be dismissable by clicking off or voice command. Currently the close button exists in InlineCameraCard but the onClose prop is never passed, and Claude doesn't know about the close_live_feed tool.

Output: Working camera dismissal via X button click and voice commands like "close the camera" or "stop showing the feed"
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-web-ui-redesign/31-RESEARCH.md
@jarvis-ui/src/components/center/ChatMessage.tsx
@jarvis-ui/src/components/center/InlineCameraCard.tsx
@jarvis-ui/src/stores/chat.ts
@jarvis-backend/src/ai/tools.ts
@jarvis-backend/src/ai/system-prompt.ts
@jarvis-backend/src/mcp/tools/smarthome.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire onClose handler to InlineCameraCard</name>
  <files>jarvis-ui/src/components/center/ChatMessage.tsx</files>
  <action>
    In ChatMessage.tsx, update the InlineCameraCard rendering (around line 138-139) to pass the onClose prop.

    Current code:
    ```tsx
    {message.inlineCamera && (
      <InlineCameraCard camera={message.inlineCamera.camera} />
    )}
    ```

    Updated code:
    ```tsx
    {message.inlineCamera && (
      <InlineCameraCard
        camera={message.inlineCamera.camera}
        onClose={() => useChatStore.getState().clearInlineCamera()}
      />
    )}
    ```

    Note: useChatStore is already imported at the top of the file (via ToolStatusCard usage pattern). If not directly imported, add:
    ```tsx
    import { useChatStore } from '../../stores/chat';
    ```
  </action>
  <verify>
    1. Build passes: `cd /root/jarvis-ui && npm run build`
    2. No TypeScript errors
    3. Grep confirms the change: `grep -n "onClose" /root/jarvis-ui/src/components/center/ChatMessage.tsx`
  </verify>
  <done>InlineCameraCard receives onClose prop that calls clearInlineCamera(), X button is clickable and dismisses camera</done>
</task>

<task type="auto">
  <name>Task 2: Add close_live_feed to Claude tool definitions</name>
  <files>jarvis-backend/src/ai/tools.ts</files>
  <action>
    In tools.ts, add the close_live_feed tool definition. Place it right after the show_live_feed tool (search for "show_live_feed" and add after).

    Add this tool definition:
    ```typescript
    {
      name: 'close_live_feed',
      description:
        'Close/stop a live camera feed in the dashboard UI. Use when the user asks to stop showing, close, hide, dismiss, or turn off a camera stream. Common triggers: "close the camera", "stop showing the feed", "hide the video", "dismiss".',
      input_schema: {
        type: 'object' as const,
        properties: {},
        required: [],
      },
    },
    ```

    This matches the existing MCP tool in smarthome.ts which takes no parameters (it closes any open feed).
  </action>
  <verify>
    1. Build passes: `cd /root/jarvis-backend && npm run build`
    2. Tool exists in output: `grep -A5 "close_live_feed" /root/jarvis-backend/src/ai/tools.ts`
  </verify>
  <done>close_live_feed tool is defined in Claude tools with clear description for voice intent detection</done>
</task>

<task type="auto">
  <name>Task 3: Update system prompt with close_live_feed guidance</name>
  <files>jarvis-backend/src/ai/system-prompt.ts</files>
  <action>
    In system-prompt.ts, find the Smart Home & Security section (search for "show_live_feed"). Update the line to include close_live_feed:

    Current (around line 73):
    ```
    - show_live_feed: Display a live camera stream in the dashboard
    ```

    Updated:
    ```
    - show_live_feed / close_live_feed: Display or dismiss a live camera stream in the dashboard
    ```

    This provides Claude with clear guidance that close_live_feed exists as the counterpart to show_live_feed.
  </action>
  <verify>
    1. Build passes: `cd /root/jarvis-backend && npm run build`
    2. System prompt includes guidance: `grep "close_live_feed" /root/jarvis-backend/src/ai/system-prompt.ts`
  </verify>
  <done>System prompt guides Claude to use close_live_feed when user wants to dismiss camera</done>
</task>

</tasks>

<verification>
1. **Click dismissal test:**
   - Start the UI: `cd /root && docker compose up -d --build`
   - Open http://192.168.1.50:3004
   - Ask "Show me the front door camera"
   - Camera appears inline in chat
   - Click the X button in camera header
   - Camera disappears

2. **Voice dismissal test:**
   - Enable voice mode in settings
   - Ask "Show me the front door camera"
   - Camera appears
   - Say "Close the camera" or "Stop showing the feed"
   - Jarvis acknowledges and camera disappears

3. **Tool registration verification:**
   ```bash
   # Check tool is in Claude's available tools
   grep -c "close_live_feed" /root/jarvis-backend/dist/ai/tools.js
   # Should return 1 or more
   ```
</verification>

<success_criteria>
- InlineCameraCard onClose prop is wired to clearInlineCamera()
- close_live_feed tool is defined in tools.ts with intuitive description
- System prompt mentions close_live_feed alongside show_live_feed
- User can dismiss inline camera via X button click
- User can dismiss inline camera via voice command
- Build completes without errors for both frontend and backend
</success_criteria>

<output>
After completion, create `.planning/phases/31-web-ui-redesign/31-01-SUMMARY.md`
</output>
