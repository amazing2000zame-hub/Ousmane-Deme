---
phase: 12-file-operations-foundation
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - jarvis-backend/src/mcp/tools/files.ts
  - jarvis-backend/src/safety/tiers.ts
  - jarvis-backend/src/ai/tools.ts
  - jarvis-backend/src/mcp/server.ts
autonomous: true

must_haves:
  truths:
    - "User can ask JARVIS to list contents of any directory on any cluster node and see file names, sizes, and types"
    - "Directory listings show tree-view format with sizes"
    - "Large directories (>50 items) are summarized with item counts instead of full listing"
    - "Dotfiles are shown by default, known noise files (.DS_Store, Thumbs.db) are excluded"
    - "JARVIS rejects listing attempts on protected directories"
  artifacts:
    - path: "jarvis-backend/src/mcp/tools/files.ts"
      provides: "list_directory and get_file_info MCP tool handlers"
      exports: ["registerFileTools"]
    - path: "jarvis-backend/src/safety/tiers.ts"
      provides: "GREEN tier entries for list_directory and get_file_info"
      contains: "list_directory: ActionTier.GREEN"
    - path: "jarvis-backend/src/ai/tools.ts"
      provides: "Claude tool definitions for list_directory and get_file_info"
      contains: "list_directory"
    - path: "jarvis-backend/src/mcp/server.ts"
      provides: "Registration call for registerFileTools"
      contains: "registerFileTools"
  key_links:
    - from: "jarvis-backend/src/mcp/tools/files.ts"
      to: "jarvis-backend/src/safety/paths.ts"
      via: "sanitizePath() called before every file/dir access"
      pattern: "sanitizePath"
    - from: "jarvis-backend/src/mcp/tools/files.ts"
      to: "jarvis-backend/src/clients/ssh.ts"
      via: "execOnNodeByName() for remote node directory listing"
      pattern: "execOnNodeByName"
    - from: "jarvis-backend/src/mcp/server.ts"
      to: "jarvis-backend/src/mcp/tools/files.ts"
      via: "registerFileTools(mcpServer) call"
      pattern: "registerFileTools"
---

<objective>
Create two GREEN-tier MCP tools: `list_directory` (tree-view directory listing with sizes and smart summarization) and `get_file_info` (detailed file metadata). Wire them into the 3-place registration pattern (handler, tier, Claude description).

Purpose: Users can ask JARVIS to browse directories on any cluster node -- the foundation for all file-aware features.
Output: Two working MCP tools registered and callable via the agentic loop.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-file-operations-foundation/12-RESEARCH.md
@.planning/phases/12-file-operations-foundation/12-CONTEXT.md
@.planning/phases/12-file-operations-foundation/12-01-SUMMARY.md

Source files (existing patterns to follow exactly):
@jarvis-backend/src/mcp/tools/system.ts
@jarvis-backend/src/mcp/server.ts
@jarvis-backend/src/safety/tiers.ts
@jarvis-backend/src/ai/tools.ts
@jarvis-backend/src/clients/ssh.ts
@jarvis-backend/src/safety/sanitize.ts
@jarvis-backend/src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file listing and info MCP tool handlers</name>
  <files>
    jarvis-backend/src/mcp/tools/files.ts
  </files>
  <action>
    Create `src/mcp/tools/files.ts` following the EXACT pattern from `tools/system.ts`:
    - Import `z` from `zod`, `McpServer` type, `sanitizeNodeName` from sanitize, `sanitizePath` and `logSafetyAudit` from `../../safety/paths.js`, `execOnNodeByName` from `../../clients/ssh.js`
    - Export `registerFileTools(server: McpServer): void`

    **Tool 1: `list_directory`** (GREEN tier)

    Parameters (Zod schema):
    - `node`: z.string() -- "Cluster node name (Home, pve, agent1, agent). Use 'Home' for the local node."
    - `path`: z.string() -- "Absolute directory path to list"
    - `showHidden`: z.boolean().optional().default(true) -- "Show dotfiles (default: true)"
    - `maxItems`: z.number().optional().default(50) -- "Max items before summarizing (default: 50)"

    Handler logic:
    1. Sanitize node name via `sanitizeNodeName(node)`
    2. Sanitize path via `sanitizePath(path)` -- if not safe, call `logSafetyAudit('protected_path_blocked', ...)` and return the denial reason as error
    3. Determine if local (node is "Home") or remote
    4. For LOCAL (Home node):
       - Use `fs.readdir(resolvedPath, { withFileTypes: true })` from `node:fs/promises`
       - For each entry: get name, type (file/directory/symlink), size (via `fs.stat()` for files), itemCount (via `fs.readdir().length` for directories)
       - Filter out noise files: `.DS_Store`, `.Spotlight-V100`, `.Trashes`, `Thumbs.db`, `._.` prefixed files
       - If `!showHidden`, filter out all dotfiles
       - If entries exceed `maxItems`, group by type: show directories with item counts, show first 20 files, add summary line "... and N more files"
    5. For REMOTE nodes:
       - Build and execute a single SSH command that produces JSON-parseable output. Use: `ls -la --block-size=1 <path>` via `execOnNodeByName()` with 15s timeout
       - Parse the ls output to extract name, type (d=directory, l=symlink, -=file), size
       - Apply the same filtering and summarization logic
    6. Format output as a tree-view string:
       ```
       /opt/jarvis-backend/src/
       +-- safety/ (8 items)
       +-- mcp/ (5 items)
       |   +-- tools/ (4 items)
       +-- config.ts (2.4KB)
       +-- index.ts (856B)
       ```
    7. Return `{ content: [{ type: 'text', text: treeOutput }] }` -- NOT JSON, but the formatted tree string so Claude can present it naturally to the user

    **Tool 2: `get_file_info`** (GREEN tier)

    Parameters (Zod schema):
    - `node`: z.string() -- "Cluster node name"
    - `path`: z.string() -- "Absolute file or directory path"

    Handler logic:
    1. Sanitize node and path (same as above)
    2. For LOCAL: use `fs.stat()` to get size, type, permissions, modified date, created date
    3. For REMOTE: use `stat --format='{"size":%s,"type":"%F","perms":"%A","modified":"%Y","name":"%n"}' <path>` via SSH
    4. Return JSON with: name, path, node, type, size (human-readable), permissions, modified (ISO date), isSymlink

    Both tools:
    - Wrap in try/catch, return `{ content: [...], isError: true }` on error
    - Use `type: 'text' as const` (match existing pattern)
    - Log safety audit on any path rejection
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - File exists at `src/mcp/tools/files.ts`
    - File exports `registerFileTools`
    - Tool handlers call `sanitizePath()` before any filesystem access
    - Tree-view formatting produces readable output
  </verify>
  <done>
    list_directory returns tree-view formatted output with file sizes, directory item counts, and smart summarization for large directories. get_file_info returns structured metadata. Both work on local and remote nodes. Both enforce path sanitization before any access.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register file tools in the 3-place pattern (tier, Claude description, server)</name>
  <files>
    jarvis-backend/src/safety/tiers.ts
    jarvis-backend/src/ai/tools.ts
    jarvis-backend/src/mcp/server.ts
  </files>
  <action>
    **1. Add tier entries in `src/safety/tiers.ts`:**

    Add to the `TOOL_TIERS` record, in a new comment block after the existing GREEN tools:

    ```typescript
    // GREEN -- read-only file operations
    list_directory: ActionTier.GREEN,
    get_file_info: ActionTier.GREEN,
    ```

    **2. Add Claude tool definitions in `src/ai/tools.ts`:**

    Add two entries to the `getClaudeTools()` return array, in a new GREEN section after the existing GREEN cluster monitoring tools:

    ```typescript
    // GREEN tier -- read-only file operations
    {
      name: 'list_directory',
      description:
        'List the contents of a directory on any cluster node. Returns a tree-view with file sizes and directory item counts. Use when the user asks to see what files are in a directory, browse a folder, or explore a project structure. Supports all 4 cluster nodes (Home, pve, agent1, agent).',
      input_schema: {
        type: 'object' as const,
        properties: {
          node: {
            type: 'string',
            description: 'Cluster node name: "Home", "pve", "agent1", or "agent"',
          },
          path: {
            type: 'string',
            description: 'Absolute directory path (e.g., "/opt/jarvis-backend/src")',
          },
          showHidden: {
            type: 'boolean',
            description: 'Show dotfiles (default: true)',
          },
          maxItems: {
            type: 'number',
            description: 'Max items before summarizing with counts (default: 50)',
          },
        },
        required: ['node', 'path'],
      },
    },
    {
      name: 'get_file_info',
      description:
        'Get detailed metadata about a specific file or directory on any cluster node. Returns size, type, permissions, and modification date. Use when the user asks about a specific file\'s details, size, or when it was last modified.',
      input_schema: {
        type: 'object' as const,
        properties: {
          node: {
            type: 'string',
            description: 'Cluster node name: "Home", "pve", "agent1", or "agent"',
          },
          path: {
            type: 'string',
            description: 'Absolute file or directory path',
          },
        },
        required: ['node', 'path'],
      },
    },
    ```

    **3. Register in `src/mcp/server.ts`:**

    Add import at the top with other tool imports:
    ```typescript
    import { registerFileTools } from './tools/files.js';
    ```

    Add registration call after existing registrations (after line ~98):
    ```typescript
    registerFileTools(mcpServer);
    ```

    Update the JSDoc comment at the top of server.ts to reflect the new tool count (was 18, now 20).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `tiers.ts` contains `list_directory: ActionTier.GREEN` and `get_file_info: ActionTier.GREEN`
    - `tools.ts` contains Claude descriptions for both tools
    - `server.ts` imports and calls `registerFileTools(mcpServer)`
    - `server.ts` JSDoc says 20 tools (not 18)
  </verify>
  <done>
    list_directory and get_file_info are fully wired into the 3-place registration pattern. Both are GREEN tier (auto-execute, no confirmation needed). Claude has descriptions optimized for tool selection. The MCP server registers both tools at startup.
  </done>
</task>

</tasks>

<verification>
Run from `jarvis-backend/` directory:

1. `npx tsc --noEmit` -- full project compiles with no errors
2. Verify `TOOL_TIERS` has both new entries: grep for `list_directory` and `get_file_info` in tiers.ts
3. Verify `getClaudeTools()` returns 20 tools (was 18): count tool objects in tools.ts
4. Verify server.ts registers file tools: grep for `registerFileTools` in server.ts
5. Verify files.ts calls sanitizePath: grep for `sanitizePath` in files.ts
</verification>

<success_criteria>
- list_directory tool returns tree-view formatted output with sizes for any cluster node
- get_file_info tool returns file metadata (size, type, permissions, modified date) for any cluster node
- Both tools enforce path sanitization (reject traversal, protected paths)
- Both tools are GREEN tier (auto-execute)
- Both tools have Claude-optimized descriptions for tool selection
- Both tools registered in MCP server (3-place pattern complete)
- Total registered tools: 20 (was 18)
</success_criteria>

<output>
After completion, create `.planning/phases/12-file-operations-foundation/12-02-SUMMARY.md`
</output>
