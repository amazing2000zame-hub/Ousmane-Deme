---
phase: 33-audio-hardware-foundation
plan: 02
type: execute
wave: 2
depends_on: ["33-01"]
files_modified:
  - /etc/asound.conf
  - /etc/modprobe.d/alsa-base.conf
autonomous: false

must_haves:
  truths:
    - "arecord -d 5 test.wav captures audible speech from a physical microphone"
    - "Multiple processes can simultaneously access the capture device via ALSA dsnoop"
    - "Multiple processes can simultaneously play audio via ALSA dmix"
    - "aplay test.wav plays audio through a physical speaker"
    - "Audio device configuration survives reboot (card numbering is pinned)"
  artifacts:
    - path: "/etc/asound.conf"
      provides: "ALSA dmix/dsnoop/asym configuration for multi-process audio sharing"
      contains: "pcm.!default"
    - path: "/etc/modprobe.d/alsa-base.conf"
      provides: "Pinned ALSA card indices to prevent numbering changes across reboots"
      contains: "options snd"
    - path: "/tmp/test-mic.wav"
      provides: "Verified microphone capture test recording"
  key_links:
    - from: "/etc/asound.conf"
      to: "ALSA library"
      via: "libasound config loading"
      pattern: "pcm.!default.*plug.*duplex"
    - from: "/etc/modprobe.d/alsa-base.conf"
      to: "kernel module loading"
      via: "modprobe options"
      pattern: "index="
---

<objective>
Ensure a working microphone captures audio (USB fallback if SOF mics failed in Plan 01), configure ALSA dmix/dsnoop for multi-process audio sharing, pin card indices for reboot stability, and verify speaker output.

Purpose: Phase 34+ (the capture daemon) needs reliable audio I/O that multiple processes can share. This plan establishes the stable ALSA foundation that all subsequent voice phases depend on.

Output: Working `/etc/asound.conf` with dmix/dsnoop, pinned card indices in `/etc/modprobe.d/alsa-base.conf`, verified mic capture and speaker playback.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-audio-hardware-foundation/33-RESEARCH.md
@.planning/phases/33-audio-hardware-foundation/33-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Establish working microphone (USB fallback if SOF failed)</name>
  <files>/etc/modprobe.d/alsa-base.conf</files>
  <action>
Read the 33-01-SUMMARY.md to determine whether SOF digital mics are working.

**Path A: SOF digital mics working (arecord -l shows Intel capture device)**

1. Identify the card number and device number from `arecord -l` output.
2. Note the card ID string from `cat /proc/asound/cards` (e.g., "sofhdadsp" or similar).
3. Test capture quality:
   ```bash
   arecord -D hw:CARD_NUM,DEV_NUM -d 5 -f S16_LE -r 16000 -c 1 /tmp/test-mic.wav
   ls -la /tmp/test-mic.wav
   ```
   File should be ~160KB for 5 seconds at 16kHz mono 16-bit.
4. Check hardware-supported rates for the capture device:
   ```bash
   arecord --dump-hw-params -D hw:CARD_NUM,DEV_NUM /dev/null 2>&1 | head -30
   ```
   Note the supported sample rates -- this informs the dsnoop config in Task 2.
5. Pin card indices in `/etc/modprobe.d/alsa-base.conf`:
   ```
   # Pin Intel HDA (SOF) as card 0
   options snd_sof_pci_intel_tgl index=0
   # Pin NVIDIA HDA as card 1
   options snd_hda_intel index=1
   ```
   Adjust module names based on actual loaded modules (`lsmod | grep snd`).

**Path B: SOF digital mics NOT working (arecord -l shows no Intel capture)**

1. This is the USB mic fallback path. The user needs to connect a USB microphone or USB speakerphone.
2. Create a checkpoint (this task becomes a human-action):
   - Instruct user to connect a USB audio device to any USB port on the Home node.
   - After connection, verify detection:
     ```bash
     arecord -l
     cat /proc/asound/cards
     lsusb | grep -i audio
     ```
3. Once USB device is detected, identify the card number and device number.
4. Test capture:
   ```bash
   arecord -D hw:CARD_NUM,DEV_NUM -d 5 -f S16_LE -r 16000 -c 1 /tmp/test-mic.wav
   ls -la /tmp/test-mic.wav
   ```
5. Check hardware-supported rates:
   ```bash
   arecord --dump-hw-params -D hw:CARD_NUM,DEV_NUM /dev/null 2>&1 | head -30
   ```
6. Pin card indices in `/etc/modprobe.d/alsa-base.conf`:
   ```
   # Pin USB audio as card 0 (primary capture/playback)
   options snd_usb_audio index=0
   # Pin NVIDIA HDA as card 1
   options snd_hda_intel index=1
   ```
   If SOF card also exists (but without working mics), assign it index=2.

In either path, the result must be a working capture device with known card/device numbers and supported sample rates.
  </action>
  <verify>
- `arecord -l` shows at least one capture device
- `/tmp/test-mic.wav` exists and is ~160KB (5s at 16kHz mono)
- Hardware-supported sample rates are documented
- `/etc/modprobe.d/alsa-base.conf` exists with pinned card indices
  </verify>
  <done>A physical microphone (SOF or USB) captures audio. Card indices are pinned for reboot stability. Supported sample rates are known.</done>
</task>

<task type="auto">
  <name>Task 2: Configure ALSA dmix/dsnoop for multi-process audio sharing</name>
  <files>/etc/asound.conf</files>
  <action>
Using the card ID and supported sample rates from Task 1, create `/etc/asound.conf`:

**IMPORTANT:** Use card ID strings (from `/proc/asound/cards`), NOT card numbers, to survive reboot re-ordering. If the card ID is not usable, use the pinned index from alsa-base.conf.

```
# /etc/asound.conf -- ALSA multi-process sharing for Jarvis voice agent
# Generated for Phase 33 Audio Hardware Foundation

# Reference to the physical capture+playback hardware
# Adjust card ID based on actual hardware detected in Task 1
pcm.snd_card_play {
    type hw
    card "CARD_ID"    # e.g., "sofhdadsp" or "USB" -- from /proc/asound/cards
    device 0
}

pcm.snd_card_cap {
    type hw
    card "CARD_ID"    # Same card if it has both capture+playback, or different card
    device 0
}

# Software mixing for playback (multiple writers)
pcm.dmixer {
    type dmix
    ipc_key 1024
    ipc_perm 0660
    slave {
        pcm "snd_card_play"
        rate 48000
        channels 2
        period_size 1024
        buffer_size 4096
    }
}

# Shared capture (multiple readers)
# Use a sample rate the hardware actually supports (from --dump-hw-params)
pcm.dsnooper {
    type dsnoop
    ipc_key 1025
    ipc_perm 0660
    slave {
        pcm "snd_card_cap"
        rate 16000          # Adjust if hardware does not support 16000 natively
        channels 1
        period_size 1024
        buffer_size 4096
    }
}

# Full duplex: combine playback + capture
pcm.duplex {
    type asym
    playback.pcm "dmixer"
    capture.pcm "dsnooper"
}

# Automatic format conversion wrapper
pcm.!default {
    type plug
    slave.pcm "duplex"
}

ctl.!default {
    type hw
    card "CARD_ID"    # Primary card
}
```

**Adjustments to make:**
- Replace `CARD_ID` with actual card ID string from `/proc/asound/cards`
- If capture and playback are on different cards (e.g., USB mic + NVIDIA HDMI), use different card references for `snd_card_play` and `snd_card_cap`
- If the hardware does not support 16000 Hz natively for capture, set dsnoop rate to the nearest supported rate (e.g., 48000) -- the `plug` wrapper will resample for applications
- If the capture device is mono-only, set channels to 1 in dsnoop

After writing the file, verify multi-process access:

```bash
# Terminal 1: Start a capture (background)
arecord -d 10 -f S16_LE -r 16000 -c 1 /tmp/multi-test1.wav &
PID1=$!

# Terminal 2: Start another capture simultaneously
arecord -d 5 -f S16_LE -r 16000 -c 1 /tmp/multi-test2.wav

# Wait for first to finish
wait $PID1

# Both files should exist and have appropriate sizes
ls -la /tmp/multi-test1.wav /tmp/multi-test2.wav
```

If the simultaneous capture fails with "Device or resource busy", dsnoop is not configured correctly. Debug by checking the error message and adjusting the asound.conf.
  </action>
  <verify>
- `/etc/asound.conf` exists with dmix, dsnoop, asym, and plug configuration
- `arecord -d 3 /tmp/verify-default.wav` captures audio using the default device (goes through plug -> dsnoop)
- Two simultaneous `arecord` processes can capture without "Device or resource busy" errors
- Card IDs (not numbers) are used in the configuration
  </verify>
  <done>ALSA dmix/dsnoop configuration is active. Multiple processes can share the audio capture and playback devices simultaneously.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify speaker output and end-to-end audio path</name>
  <action>
Automated verification was completed in Tasks 1 and 2. This checkpoint confirms the user can hear audio and speak into the microphone.
  </action>
  <what-built>
Complete audio hardware foundation: microphone capture (SOF or USB), ALSA multi-process sharing (dmix/dsnoop), pinned card indices, and speaker output configuration.
  </what-built>
  <how-to-verify>
1. **Test microphone capture with audible speech:**
   ```bash
   # Speak into the microphone while this runs
   arecord -d 5 -f S16_LE -r 16000 -c 1 /tmp/final-test.wav
   ```
   The file should be ~160KB.

2. **Test speaker playback:**
   ```bash
   # Play back through default output device
   aplay /tmp/final-test.wav
   ```
   You should hear your recorded speech. If using HDMI output, a display must be connected. If using USB speakerphone, audio plays through its speaker.

   If no playback device is available (headless, no USB speaker, no HDMI display):
   ```bash
   # Generate a test tone to verify the ALSA path works even if no speaker is connected
   speaker-test -t sine -f 440 -l 1 -D default 2>&1 | head -5
   ```
   This verifies the ALSA configuration is correct even if no audible output is heard.

3. **Verify multi-process sharing works:**
   ```bash
   # Two captures at once
   arecord -d 5 /tmp/mp-test1.wav &
   arecord -d 3 /tmp/mp-test2.wav
   wait
   ls -la /tmp/mp-test1.wav /tmp/mp-test2.wav
   ```
   Both files should exist with appropriate sizes (no "Device busy" errors).

4. **Verify configuration survives conceptually** (actual reboot test is optional):
   ```bash
   cat /etc/modprobe.d/alsa-base.conf   # Card indices pinned
   cat /etc/asound.conf                  # dmix/dsnoop configured
   cat /proc/asound/cards                # Current card listing
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if audio capture and playback work, or describe any issues (no speaker available, capture is silent, etc.)</resume-signal>
</task>

</tasks>

<verification>
1. `arecord -d 5 /tmp/test.wav` captures ~160KB of audio from a physical microphone
2. `arecord -l` shows at least one capture device (SOF or USB)
3. `/etc/asound.conf` has dmix/dsnoop/asym/plug configuration using card IDs
4. `/etc/modprobe.d/alsa-base.conf` pins card indices
5. Two simultaneous `arecord` processes succeed (no "Device busy")
6. `aplay /tmp/test.wav` plays audio (or speaker-test confirms ALSA path works)
</verification>

<success_criteria>
- Physical microphone captures audible speech via `arecord`
- ALSA dmix/dsnoop allows multiple processes to share audio devices
- Speaker output works (or is confirmed as needing USB speaker purchase)
- Card numbering is pinned for reboot stability
- Audio foundation is ready for Phase 34 (capture daemon)
</success_criteria>

<output>
After completion, create `.planning/phases/33-audio-hardware-foundation/33-02-SUMMARY.md`
</output>
