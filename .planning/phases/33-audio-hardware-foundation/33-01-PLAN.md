---
phase: 33-audio-hardware-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /etc/modprobe.d/vfio.conf
autonomous: false

must_haves:
  truths:
    - "Intel iGPU is released from vfio-pci and claimed by i915 driver after reboot"
    - "SOF audio driver probes successfully (no deferred probe errors in dmesg)"
    - "At least one capture device appears in arecord -l (either Intel SOF digital mics or determination that they do not work)"
    - "Cluster quorum is maintained throughout the reboot (3 other nodes remain online)"
  artifacts:
    - path: "/etc/modprobe.d/vfio.conf"
      provides: "Cleaned VFIO config with orphaned iGPU passthrough removed"
    - path: "/tmp/pre-reboot-check.log"
      provides: "Cluster quorum verification before reboot"
  key_links:
    - from: "/etc/modprobe.d/vfio.conf"
      to: "initramfs"
      via: "update-initramfs -u"
      pattern: "vfio-pci.*8086:468b removed"
    - from: "i915 driver"
      to: "sof-audio-pci-intel-tgl"
      via: "HDMI codec initialization"
      pattern: "Kernel driver in use: i915"
---

<objective>
Remove orphaned VFIO iGPU passthrough configuration, install alsa-ucm-conf, rebuild initramfs, reboot the Home node, and verify whether Intel SOF digital microphones activate.

Purpose: The SOF audio driver cannot probe because vfio-pci holds the Intel iGPU, preventing i915 from initializing the HDMI codec path. Removing this orphaned config (VM 100 migrated to agent1) and rebooting is the prerequisite for any audio capture on the Home node.

Output: Working Intel SOF audio hardware (capture devices visible in `arecord -l`), or a definitive determination that built-in digital mics do not work and USB fallback is needed.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-audio-hardware-foundation/33-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pre-reboot preparation -- remove VFIO config, install UCM, rebuild initramfs</name>
  <files>/etc/modprobe.d/vfio.conf</files>
  <action>
1. Verify cluster quorum is healthy before making any changes:
   ```bash
   pvecm status
   ssh root@192.168.1.74 "hostname && uptime"
   ssh root@192.168.1.61 "hostname && uptime"
   ssh root@192.168.1.62 "hostname && uptime"
   ```
   All 3 other nodes must be online. Save output to `/tmp/pre-reboot-check.log`. If any node is down, STOP -- do not proceed until quorum is safe.

2. Back up the current VFIO config:
   ```bash
   cp /etc/modprobe.d/vfio.conf /etc/modprobe.d/vfio.conf.bak.$(date +%Y%m%d)
   ```

3. Edit `/etc/modprobe.d/vfio.conf` to remove the two orphaned iGPU passthrough lines:
   - Remove: `options vfio-pci ids=8086:468b`
   - Remove: `softdep i915 pre: vfio-pci`
   - If no other content remains, leave the file empty (do NOT delete the file).
   - The `intel_iommu=on iommu=pt` kernel boot parameters should NOT be changed (they are in GRUB, not this file, and are still needed for Proxmox).

4. Install alsa-ucm-conf (SOF Use Case Manager profiles):
   ```bash
   apt update && apt install -y alsa-ucm-conf
   ```

5. Rebuild initramfs to bake in the VFIO config changes:
   ```bash
   update-initramfs -u
   ```
   This is CRITICAL -- without this, the old VFIO config persists in the boot image and the reboot changes nothing.

6. Verify the initramfs was rebuilt (check timestamp):
   ```bash
   ls -la /boot/initrd.img-$(uname -r)
   ```
  </action>
  <verify>
- `/etc/modprobe.d/vfio.conf` no longer contains `8086:468b` or `softdep i915`
- `/etc/modprobe.d/vfio.conf.bak.*` backup exists
- `dpkg -l alsa-ucm-conf` shows installed
- `/boot/initrd.img-*` timestamp is recent (within last few minutes)
- `/tmp/pre-reboot-check.log` shows all 3 nodes online
  </verify>
  <done>VFIO iGPU passthrough config removed, alsa-ucm-conf installed, initramfs rebuilt. System is ready for reboot.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Reboot Home node and wait for it to come back online</name>
  <action>
The Home node must be rebooted for the VFIO/initramfs changes to take effect. This cannot be done by Claude because the SSH connection will be lost during reboot and Claude runs on this node.

**Before rebooting, note:** The reboot will temporarily take down:
- Jarvis backend (Docker stack on port 4000)
- Jarvis frontend (Docker stack on port 3004)
- llama-server (systemd on port 8080)
- Samba shares (NetworkStorage2, SecurityCameras, ExternalHDD)
- NFS export for camera recordings

Cluster quorum will be maintained by the other 3 nodes.
  </action>
  <instructions>
1. From the Home node terminal (or SSH from another node), run:
   ```bash
   reboot
   ```
2. Wait 2-3 minutes for the node to come back online.
3. SSH back in: `ssh root@192.168.1.50`
4. Verify the node is up: `uptime`
5. Resume Claude Code and tell it to proceed with Task 3.
  </instructions>
  <resume-signal>Type "rebooted" or "back online" to continue with post-reboot verification</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Post-reboot verification -- check SOF audio driver and capture devices</name>
  <files></files>
  <action>
After the reboot, verify the audio subsystem:

1. Check that i915 now claims the iGPU (NOT vfio-pci):
   ```bash
   lspci -v -s 00:02.0 | grep "Kernel driver"
   ```
   Expected: `Kernel driver in use: i915`

2. Check SOF audio driver status:
   ```bash
   dmesg | grep -i sof | head -20
   dmesg | grep -i "deferred probe" | head -10
   ```
   Expected: SOF probes successfully, no deferred probe errors.

3. List all sound cards:
   ```bash
   cat /proc/asound/cards
   ```

4. List capture devices (microphones):
   ```bash
   arecord -l
   ```

5. List playback devices (speakers):
   ```bash
   aplay -l
   ```

6. Check VFIO is no longer holding the iGPU:
   ```bash
   ls /sys/bus/pci/drivers/vfio-pci/ 2>/dev/null
   ```

7. Verify cluster rejoined:
   ```bash
   pvecm status
   ```

8. **If `arecord -l` shows capture devices (Intel digital mics):**
   - Record a 5-second test: `arecord -d 5 -f S16_LE -r 16000 -c 1 /tmp/test-mic.wav`
   - Check file size: `ls -la /tmp/test-mic.wav` (should be ~160KB for 5s at 16kHz mono)
   - Log result: "SOF digital mics WORKING"

9. **If `arecord -l` shows NO capture devices:**
   - Check dmesg for SOF errors: `dmesg | grep -i "sof\|snd_hda\|codec" | tail -30`
   - Log result: "SOF digital mics FAILED -- USB mic fallback needed (Plan 02)"
   - This is an acceptable outcome -- Plan 02 handles the USB mic fallback.

10. Verify Docker stack restarted:
    ```bash
    cd /root && docker compose ps
    ```
    If containers are not running, start them: `docker compose up -d`

11. Verify llama-server restarted:
    ```bash
    systemctl status jarvis-api
    ```
    If not running: `systemctl start jarvis-api`
  </action>
  <verify>
- `lspci -v -s 00:02.0` shows `Kernel driver in use: i915` (NOT vfio-pci)
- `pvecm status` shows quorum with all 4 nodes
- `arecord -l` output is captured and evaluated (either shows Intel mics or confirms they do not work)
- Docker containers are running (`docker compose ps` shows healthy)
- jarvis-api service is active (`systemctl status jarvis-api`)
  </verify>
  <done>Post-reboot verification complete. Either (a) Intel SOF digital mics are working and capture is verified with a test recording, or (b) SOF mics confirmed non-functional and USB mic fallback is documented as needed for Plan 02.</done>
</task>

</tasks>

<verification>
1. `lspci -v -s 00:02.0 | grep "Kernel driver"` shows i915
2. `dmesg | grep "deferred probe"` returns empty or shows resolved probes
3. `arecord -l` output evaluated (working mics or documented failure)
4. `pvecm status` shows healthy 4-node quorum
5. All Home node services (Docker, jarvis-api) are running
</verification>

<success_criteria>
- The Intel iGPU is released from vfio-pci and bound to i915
- SOF audio driver has probed (successfully or with documented failure)
- Capture device status is definitively known (working SOF mics OR confirmed need for USB fallback)
- Cluster quorum maintained throughout the reboot
- All Home node services restored after reboot
</success_criteria>

<output>
After completion, create `.planning/phases/33-audio-hardware-foundation/33-01-SUMMARY.md`
</output>
