# Milestone v1.6: Smart Home Intelligence

**Status:** IN PROGRESS
**Phases:** 26-33
**Target:** Give JARVIS eyes -- camera face recognition, presence tracking, and proactive alerts

## Overview

Jarvis v1.6 integrates Frigate's native face recognition with presence tracking and proactive intelligence. Users can ask "Who's at the door?" and get face-identified answers, track arrival/departure patterns, view camera feeds in the dashboard, and receive proactive alerts for unknown persons. The build leverages existing Frigate 0.16.4 infrastructure (face recognition available but disabled) and extends the current MCP tool set.

## Phases

### Phase 26: Face Recognition Foundation

**Goal:** Users can ask "Who's at the door?" and receive face-identified responses using Frigate's built-in recognition.

**Depends on:** Nothing (first phase) -- extends existing Frigate integration

**Plans:** 2 plans

- [ ] 26-01: Enable Frigate face recognition, update frigate.ts client for sub_label and face library APIs
- [ ] 26-02: New MCP tools (whos_at_door, get_recognized_faces, get_unknown_visitors) with GREEN tier

**Requirements addressed:** FACE-01 through FACE-05

**Success Criteria:**
1. User asks "Who's at the door?" and JARVIS returns the recognized face name (or "unknown person")
2. User can query recent visitors by face name via natural language
3. Frigate Face Library UI at `/face-library` is accessible for manual face enrollment
4. Events with `sub_label` data are correctly parsed and returned by MCP tools
5. Unknown persons (person event without sub_label) are identifiable in query results

---

### Phase 27: Presence Intelligence

**Goal:** Users can ask "Who's home?" and get a comprehensive answer combining network presence, camera detection, and face recognition.

**Depends on:** Phase 26 (face recognition data available)

**Plans:** 2 plans

- [x] 27-01: SQLite presence_logs table, presence state tracker, enhanced get_who_is_home tool
- [ ] 27-02: Presence history MCP tool, presence context injection into system prompt

**Requirements addressed:** PRES-01 through PRES-05

**Success Criteria:**
1. User asks "Who's home?" and gets combined signal response (network + camera + face)
2. User can query "When did [person] arrive/leave?" and get historical data
3. Arrival detection: person detected at entry camera with face recognition updates presence state
4. Departure detection: phone leaving network + no recent camera sightings marks away
5. JARVIS knows who is home during conversation (presence in system prompt context)

---

### Phase 28: Camera Dashboard

**Goal:** Users can view camera snapshots, event history, and live feeds in the Jarvis dashboard without leaving the UI.

**Depends on:** Phase 26 (face-annotated events)

**Plans:** 2 plans

- [x] 28-01: CameraPanel component with snapshot grid, refresh on demand, click-to-enlarge
- [x] 28-02: EventList component with thumbnails, face labels, filters, and live view integration (MSE/go2rtc)

**Requirements addressed:** CAM-01 through CAM-05

**Success Criteria:**
1. Dashboard shows 2-camera snapshot grid (front_door, side_house) with auto-refresh
2. User can click a camera to see full-size snapshot in modal
3. Recent events panel shows detection thumbnails with face labels (recognized name or "Unknown")
4. User can filter events by camera, object type, or time range
5. Live view button opens MSE stream from go2rtc for selected camera

---

### Phase 29: Proactive Intelligence

**Goal:** JARVIS proactively notifies users of significant events (unknown person at door) via dashboard and optional TTS.

**Depends on:** Phase 26-28 (face recognition, presence state, camera UI)

**Plans:** 2 plans

- [ ] 29-01: Event subscription service (poll Frigate every 5s), unknown person detection, Socket.IO emitter
- [ ] 29-02: Dashboard notification component, TTS announcement integration, cooldown logic

**Requirements addressed:** ALERT-01 through ALERT-05

**Success Criteria:**
1. Unknown person at front_door triggers dashboard notification within 10 seconds
2. Notifications show snapshot thumbnail and camera name
3. 5-minute cooldown prevents repeated alerts for same person lingering
4. Optional TTS announcement: "Sir, there is someone I don't recognize at the front door"
5. User can ask "What happened while I was away?" and get event summary

---

### Phase 30: MCP Tool Reliability & Voice Acknowledgment ✓ COMPLETE

**Goal:** Fix MCP tool calling errors and ensure JARVIS speaks acknowledgment phrases ("One moment, sir") BEFORE executing tools, not after.

**Depends on:** Phase 29 (or parallel -- reliability fixes)

**Plans:** 2 plans — COMPLETE

Plans:
- [x] 30-01-PLAN.md -- Frontend + backend acknowledgment fixes (dedicated event, immediate playback, Piper preference)
- [x] 30-02-PLAN.md -- Tool timeout and error handling improvements (60s timeout, graceful failures)

**Requirements addressed:** REL-01 through REL-04 (new)

**Status:** Complete (2026-01-30)

**Success Criteria:**
1. ✓ User hears "One moment, sir" BEFORE any tool executes, not during/after
2. ✓ MCP tool errors are properly caught and reported to user with helpful messages
3. ✓ Tool timeouts don't hang the conversation -- graceful failure with user feedback
4. ✓ Voice acknowledgment works consistently on every tool call, not just sometimes

---

### Phase 31: Web UI Redesign

**Goal:** Fix Web UI layout issues and create a polished, responsive dashboard that works reliably.

**Depends on:** None (independent UI work)

**Plans:** 2-3 plans (TBD based on scope)

- [ ] 31-01: Audit current UI issues, fix layout bugs, responsive breakpoints
- [ ] 31-02: Redesign chat panel for better UX (inline camera display, tool outputs)
- [ ] 31-03: Polish dashboard components (camera panel, status indicators, controls)

**Requirements addressed:** UI-02 through UI-08 (new)

**Success Criteria:**
1. Dashboard loads reliably without layout glitches or broken components
2. Chat panel displays inline camera feeds correctly when requested
3. UI is responsive on desktop and tablet (primary use cases)
4. Tool outputs render cleanly without breaking layout
5. Camera feed can be dismissed by clicking off or voice command

---

### Phase 32: Jarvis Main Screen (Frigate Display on PVE)

**Goal:** The display attached to pve node becomes Jarvis's "main screen" showing Frigate feeds and accepting Jarvis commands.

**Depends on:** Phase 31 (UI must be stable), Phase 28 (camera dashboard working)

**Plans:** 2 plans

- [ ] 32-01: Configure pve display to show Jarvis dashboard/Frigate in kiosk mode
- [ ] 32-02: Add display control MCP tools (show camera, switch view, display message)

**Requirements addressed:** DISP-01 through DISP-04 (new)

**Success Criteria:**
1. PVE display boots into Jarvis dashboard/Frigate kiosk mode automatically
2. User can say "Jarvis, show front door on main screen" and display switches
3. Display shows Frigate live feeds by default with overlay status info
4. Jarvis can display text messages on screen ("Welcome home, sir")

---

### Phase 33: USB Microphone Input

**Goal:** Enable voice input via USB microphone connected directly to server, bypassing browser SSL certificate requirements.

**Depends on:** Phase 30 (voice pipeline working reliably)

**Plans:** 2 plans

- [ ] 33-01: Configure USB mic on Home node, audio capture service, wake word detection
- [ ] 33-02: Integrate server-side STT with chat pipeline, Socket.IO voice events

**Requirements addressed:** MIC-01 through MIC-04 (new)

**Success Criteria:**
1. USB microphone captures audio on Home node without browser involvement
2. Wake word "Jarvis" triggers listening mode
3. Voice input transcribed and processed same as browser STT
4. Works without SSL certificates (server-side capture)
5. Multiple input sources supported (USB mic + browser mic when available)

---

## Phase Dependencies

```
Phase 26: Face Recognition Foundation
    |
    +-------------------------------+
    |                               |
    v                               v
Phase 27: Presence Intelligence   Phase 28: Camera Dashboard (COMPLETE)
    |                               |
    +-------------------------------+
    |
    v
Phase 29: Proactive Intelligence
    |
    v
Phase 30: MCP Tool Reliability & Voice Acknowledgment
    |
    +-------------------------------+
    |                               |
    v                               v
Phase 31: Web UI Redesign        Phase 32: Jarvis Main Screen (PVE Display)
    |                               |
    +-------------------------------+
    |
    v
Phase 33: USB Microphone Input
```

Phase 27 and 28 can proceed in parallel after Phase 26 completes.

---

## Technical Constraints

| Constraint | Impact | Mitigation |
|------------|--------|------------|
| CPU-only inference | Face recognition must use `model_size: small` | FaceNet adequate for 5-10 faces |
| 2 cameras only | Limited coverage for POC | front_door (entry), side_house (driveway) sufficient |
| No MQTT currently | Higher latency for event detection | HTTP polling at 5s interval; MQTT upgrade deferred to v1.7 |
| Single user system | Skip multi-user permissions | Simplifies presence tracking |
| LAN-only access | No remote viewing | All traffic local, no auth required for Frigate |

---

## File Change Estimates

| Phase | New Files | Modified Files | LOC Estimate |
|-------|-----------|----------------|--------------|
| 26 | 0 | 3 (frigate.ts, smarthome.ts, tiers.ts) | ~200 |
| 27 | 2 (presence.ts, schema extension) | 3 (smarthome.ts, system-prompt.ts, get_who_is_home) | ~350 |
| 28 | 3 (CameraPanel.tsx, EventList.tsx, LiveView.tsx) | 2 (CenterDisplay.tsx, stores) | ~500 |
| 29 | 2 (event-subscription.ts, NotificationToast.tsx) | 3 (server.ts, TTS integration, socket) | ~400 |
| 30 | 0 | 4 (loop.ts, server.ts, chat.ts, useChatSocket.ts, progressive-queue.ts) | ~150 |

**Total estimate:** ~1,600 LOC across 10 plans

---

## Milestone Summary

**Key Decisions:**
- Use Frigate's native face recognition (not custom ML in Jarvis)
- HTTP polling for events (5s interval) -- MQTT upgrade deferred
- SQLite for presence logs (extends existing schema)
- MSE streaming via go2rtc for live view (not HLS)
- Proactive alerts to dashboard only (TTS optional, not default)

**What's Deferred to v1.7+:**
- MQTT subscription for real-time events
- Face enrollment from chat ("JARVIS, learn this face as John")
- Historical presence patterns ("John usually arrives at 6pm")
- Multi-camera live grid (bandwidth optimization)
- Alert preferences UI (over-engineering for single user)
- Presence-based automations (needs automation engine)

---

_For requirements detail, see .planning/REQUIREMENTS-v1.6.md_
_For architecture context, see .planning/research/ARCHITECTURE.md_
